# 测试运行与修复

> 运行项目测试，识别并修复失败用例

## 输入方式

```bash
/test-run              # 运行所有测试
/test-run unit         # 仅单元测试
/test-run integration  # 仅集成测试
/test-run e2e          # 仅 E2E 测试
/test-run $ARGUMENTS
```

---

## 执行流程

### 1. 识别测试环境
- 定位测试命令（package.json / pytest.ini / Makefile / pubspec.yaml）
- 确认测试框架（Jest / Vitest / Pytest / Go test / Playwright / Flutter Test）
- 检查测试环境就绪（数据库、服务、依赖）
- **Flutter 检查**: `flutter pub get`, `flutter packages pub run build_runner build`

### 2. 运行测试
- **使用紧凑模式避免日志爆炸**: `--reporter=compact` 或 `--reporter=json`
- 执行测试命令，收集结果
- 记录失败用例和错误信息
- E2E 测试需收集截图/日志
- **Flutter 特定**: 使用 `flutter test --reporter=compact` 而非 `expanded`

### 3. 诊断失败原因

**代码问题**（修复源代码）：
- 业务逻辑错误、边界条件处理不当
- 依赖注入或 mock 配置错误
- 异步处理问题（Promise/async-await）
- 模块间接口不匹配、数据传递错误
- 事务和状态管理问题

**测试问题**（更新测试用例）：
- 断言不符合当前需求
- 测试数据过时或不正确
- 测试与实际需求不符

**环境问题**（调整配置）：
- 数据库连接、API 调用失败
- 环境变量或配置缺失
- 测试服务未正确启动
- **Flutter 特定**: Hive未初始化、Riverpod Provider未配置、SharedPreferences未mock

**稳定性问题**（优化等待策略）：
- 时序问题（元素未加载完成）
- 选择器失效或不稳定
- 异步操作等待不当
- 测试数据冲突或状态污染

### 4. 修复并验证
- 修复后重新运行测试
- 确保没有引入新问题
- 多次运行验证稳定性（E2E）
- **Token 优化**: 使用紧凑模式，避免完整日志输出，只报告关键失败信息

---

## 输出格式

```markdown
## 测试执行结果

**类型**: [unit/integration/e2e/all]
**通过**: X | **失败**: Y | **跳过**: Z

### 已修复
1. [测试名] - [问题类型] - [修复说明]

### 遗留问题（如有）
1. [测试名] - [原因] - [建议]
```

---

## 代码优化信号

修复测试时如发现以下问题，说明代码需要优化：

| 信号 | 暴露的设计问题 | 处理方式 |
|------|---------------|---------|
| 难以 mock | 依赖太多、耦合太紧 | 记录，建议拆分 |
| setup 复杂 | 单个测试需大量前置条件 | 记录，建议简化接口 |
| 无法隔离 | 测试一个功能必须牵扯多模块 | 记录，建议解耦 |
| 断言困难 | 内部状态不可观测 | 记录，建议暴露关键状态 |

**处理流程**：
- 局部问题 → 立即小重构 → 继续修复测试
- 架构问题 → 完成当前任务 → 在输出中列出优化建议

---

## 约束条件

- 优先修复代码 bug，谨慎修改测试用例
- 修改测试前理解原始设计意图
- 保持测试独立性和确定性
- E2E 使用稳定选择器（data-testid 优先）
- 避免过度 mock 导致测试失去价值

---

## 相关文档
- `/test-plan` - 测试规划（生成 DAG 任务）
