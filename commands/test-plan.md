---
description: 测试规划（DAG 编排）ultrathink
---

# 测试规划（DAG 编排）

> 运行测试 → 三维度审计 → 生成 DAG 任务文件

**关键约束**：产出必须是任务文件，不是分析报告。

## 使用方式

```bash
/test-plan                                    # 生成测试任务
python batchcc.py task-add-test --dry-run     # 预览
python batchcc.py task-add-test               # 执行
```

---

## 自主执行原则

> **强制阅读**：@templates/workflow/DAG_TASK_FORMAT.md
>
> 核心：识别缺失测试 → 自主决策 → 直接生成任务文件（不询问用户）

---

## 执行策略

### 第一步：运行现有测试并收集信号

使用精简输出模式运行测试，只看关键失败信息（避免 token 浪费）。

### 第二步：三维度测试审计

#### 维度 A：覆盖率缺口

| 优先级 | 类型 | 示例 |
|--------|------|------|
| 🔴 必须 | 认证、支付、核心业务流程 | 登录、下单、支付回调 |
| 🟡 应该 | API 接口、复杂业务逻辑 | 状态机、规则引擎 |
| 🟢 可选 | 工具函数、配置 | 纯计算、常量定义 |

#### 维度 B：测试质量审查

| 问题类型 | 信号 |
|----------|------|
| 过时测试 | 测试期望与当前代码不符 |
| 无效断言 | `expect().toBeTruthy()` 等过于宽泛 |
| 过度 Mock | 整个函数被 stub，测试的是 mock |
| 脆弱测试 | 依赖外部状态或硬编码时间 |
| 违反冰山策略 | E2E 占比过高，单元测试不足 |

#### 维度 C：业务价值评估

**不值得写的测试**：getter/setter、纯展示组件、框架生成代码、一次性脚本

### 第三步：生成任务文件

**按优先级排序**（🔴 → 🟡 → 🟢），包含清理任务：

```
task-add-test                          # 主任务文件
.test-tasks/                           # 任务细节
├── stage-1-audit.md                  # 现有测试质量审计
├── stage-2-cleanup.md                # 清理过时/无效测试
├── stage-3-critical-tests.md         # 🔴 关键路径测试（并行）
├── stage-4-important-tests.md        # 🟡 重要功能测试（并行）
└── stage-5-verification.md           # 最终验证
```

---

## TASK 格式要求

- 使用 `## TASK ##`（两边都有 `##`）
- **必须包含**：🎯 任务目标、📁 核心文件、✅ 完成标志
- **推荐包含**：🏠 项目背景、🔨 执行步骤
- `文件:` 和 `验证:` 字段必填

> 完整格式参照 @templates/workflow/DAG_TASK_FORMAT.md

**业务逻辑不清晰时**：添加 `⚠️ 需要人工确认断言逻辑` 标记

---

## Mock 数据策略

**优先级**：复用已有 fixtures > 复用已有 Factory > 创建共享 helper

**禁止**：在每个 spec 文件里硬编码大量 JSON 测试数据

---

## 字数约束

- 单个 TASK 描述：15-30 行
- 每个 stage 文件：60-120 行

## 严格禁止

1. **生成诊断报告** - 必须生成 DAG 任务文件
2. **缺少文件/验证字段** - 每个任务必须有
3. **时间估算** - 不写"预计时间: 30分钟"

---

## 相关文档

- @templates/workflow/DAG_TASK_FORMAT.md - 格式规范
- `/test-run` - 运行测试并修复失败
- `/test-audit` - 测试基础设施审计
