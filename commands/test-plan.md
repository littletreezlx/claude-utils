# 测试规划

> **用途**：全面分析项目测试现状，生成可执行的测试任务
>
> **特性**：DAG 任务编排 + 并行测试编写 + 断点续传

---

## 🤖 自主执行原则

**⛔ 强制前置阅读**：执行任何操作前，必须先阅读 @templates/workflow/DAG_TASK_FORMAT.md 的"自主执行原则"章节，否则禁止继续。

**核心**：完全自动化、无人值守执行

✅ **应该做**：自主分析测试缺口 → 自主决策测试策略 → 直接编写测试 → 记录理由
❌ **不应该**：询问用户、列测试方案让用户选

---

## 🎯 执行目标

```bash
# 1. 生成任务文件
/test-plan

# 2. 预览执行计划
python batchcc.py task-add-test --dry-run

# 3. 执行（自动断点续传）
python batchcc.py task-add-test
```

**生成文件结构**：
```
项目根目录/
├── task-add-test                      # 主任务文件
├── task-add-test.state.json           # 状态文件（自动）
└── .test-tasks/                       # 阶段详情
    ├── stage-1-infrastructure.md      # 测试基础设施
    ├── stage-2-tests.md               # 测试编写（并行）
    └── stage-3-verification.md        # 验证和覆盖度
```

---

## 📋 阶段编排

### STAGE 1: 测试基础设施（serial）
- 检查/配置测试框架（Jest/Vitest/Mocha）
- 配置覆盖率工具
- 准备测试辅助函数和 mock 工具

### STAGE 2: 测试编写（parallel）
- 各模块测试并行编写
- 单元测试、集成测试、E2E 测试

### STAGE 3: 验证（serial）
- 运行完整测试套件
- 生成覆盖率报告
- 更新测试文档

---

## 🔧 测试策略

### 优先级判断

| 维度 | 优先级高 | 优先级低 |
|------|----------|----------|
| 业务关键度 | 核心业务逻辑 | 边缘特性 |
| 复杂度 | 复杂算法 | 简单逻辑 |
| 变更频率 | 频繁修改 | 稳定代码 |
| 风险等级 | 容易出错 | 安全可靠 |

### 测试类型选择

| 代码类型 | 推荐测试 |
|----------|----------|
| 纯函数/工具类 | 单元测试 |
| 业务逻辑/服务层 | 单元 + 集成 |
| API 端点 | 集成测试 |
| 用户核心流程 | E2E 测试 |

### 务实原则

- **必须测**：核心业务、用户主流程、易破坏模块
- **可选测**：边界情况、性能测试
- **不需测**：getter/setter、纯展示组件、一次性脚本

---

## ⚠️ 重要约束

1. **并行优化** - 独立模块测试可并行，明确文件范围避免冲突
2. **测试质量** - 验证行为而非实现细节，避免脆弱测试
3. **Git 安全** - 测试前确保工作区干净

---

## 📚 相关文档

| 文档 | 用途 |
|------|------|
| @templates/workflow/DAG_TASK_FORMAT.md | DAG 语法规范 |
| /test-unit, /test-integration, /test-e2e | 日常测试运行 |
| /create-e2e-test | 单个功能 E2E 测试 |

---

## 开始执行

**执行步骤**：
1. 分析项目测试现状，识别测试缺口
2. 自主决策测试策略
3. 生成任务文件（DAG 格式 + 阶段详情文件）
4. 输出文件路径和执行命令

**关键要求**：
- ✅ 使用 DAG 格式，模块化任务文件
- ✅ 基础设施串行、测试编写并行、验证串行
- ✅ 每个 TASK 有清晰的文件范围（支持冲突检测）
- ✅ 务实的测试策略（专注核心价值）
