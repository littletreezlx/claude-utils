# E2E 测试就绪度检查

> **用途**：E2E 测试系统专项检查
>
> **适用场景**：
> - E2E 测试系统出问题时
> - 重构测试系统前
> - 补充缺失的 E2E 测试时

---

## 📋 参考框架

**深度分析框架**：`~/.claude/frameworks/DEEP_ANALYSIS_FRAMEWORK.md`

**核心原则**：
1. **代码-测试-文档三位一体** - 补充测试前必须理解现有实现
2. **测试驱动质量闭环** - 测试不仅验证功能，更能驱动代码优化
3. **完整的自主闭环** - Claude Code 必须能独立完成测试-修复循环

```
改代码 → 写测试 → 启动服务 → 运行测试 → 查看日志
                                    ↓
                          失败？立即修复
                                    ↓
                              ✅ 通过 → 交付
```

---

## 🎯 检查目标

验证项目是否满足 E2E 驱动开发的基础条件，建立完整的测试-开发闭环。

---

## 🚀 执行流程

### Step 1: 基础设施评估

**目标**：确认 E2E 测试工具链完备性

#### 1.1 识别技术栈和测试框架
- [ ] 项目类型（Web / Mobile / Desktop）
- [ ] 测试框架（Playwright / Cypress / Detox / ...）
- [ ] 测试命令（package.json / pytest.ini）

#### 1.2 检查测试配置
- [ ] 测试配置文件存在（playwright.config.ts / cypress.json）
- [ ] 配置是否合理（超时、重试、headless）
- [ ] 环境变量配置（.env.test）

#### 1.3 验证测试可运行性 ⚠️ 强制执行
```bash
# 实际运行测试（而非只看文件）
bash scripts/test-helpers/run-e2e-test.sh

# 或
pnpm test:e2e

# 或
pytest tests/e2e/

# 检查：
- [ ] 测试能否正常启动？
- [ ] 是否有环境配置错误？
- [ ] 是否有依赖缺失？
```

**输出**：
- 测试框架：[名称 + 版本]
- 测试命令：[命令]
- 配置问题：[列表]
- 运行状态：✅ 可运行 / ❌ 无法运行

---

### Step 2: 测试覆盖度评估

**目标**：识别核心功能的 E2E 测试覆盖情况

#### 2.1 识别核心功能
基于 FEATURE_CODE_MAP.md 或代码分析，识别 5-10 个核心功能

#### 2.2 检查测试覆盖
对每个核心功能：
- [ ] 是否有对应的 E2E 测试文件？
- [ ] 测试是否覆盖核心流程？
- [ ] 测试是否覆盖错误场景？

#### 2.3 运行测试并分析结果 ⚠️ 强制执行
```bash
# 实际运行所有 E2E 测试
bash scripts/test-helpers/run-e2e-optimized.sh

# 检查：
- [ ] 所有测试是否通过？
- [ ] 失败的测试是什么原因？
- [ ] 是否有 skip 或 only？
```

**输出**：
- 核心功能列表（X 个）
- 有测试的功能（Y 个）
- 缺失测试的功能（X-Y 个，按优先级排序）
- 测试通过率：Y/X
- 失败测试列表（文件路径 + 原因）

---

### Step 3: 测试质量评估

**目标**：评估现有 E2E 测试的质量

#### 3.1 测试代码质量（抽样 5-10 个测试文件）

**检查点**：
- [ ] 测试描述是否清晰？（使用 Given-When-Then）
- [ ] 选择器是否规范？（优先 data-testid）
- [ ] 断言是否具体？（避免只检查可见性）
- [ ] 错误处理是否完善？（timeout、网络错误）

**好的测试示例**：
```typescript
test("用户下载 YouTube 视频的完整流程", async ({ page }) => {
  // Given: 用户打开下载页面
  await page.goto("/downloads");

  // When: 用户输入 URL 并点击下载
  await page.fill('[data-testid="url-input"]', url);
  await page.click('[data-testid="download-button"]');

  // Then: 系统显示成功消息
  await expect(page.locator('[data-testid="success-msg"]'))
    .toContainText("已添加到下载队列");
});
```

#### 3.2 测试稳定性
- [ ] 是否有 flaky 测试（时而通过时而失败）？
- [ ] 是否有超时问题？
- [ ] 是否有依赖外部服务的测试？

#### 3.3 测试维护性
- [ ] 是否使用 Page Object 模式？
- [ ] 测试数据是否集中管理？
- [ ] 是否有重复的测试代码？

**输出**：
- 测试质量问题列表（具体到文件路径）
- Flaky 测试列表
- 建议的改进方案

---

### Step 4: 测试-代码-文档一致性

**目标**：验证测试与代码、文档是否同步

#### 4.1 测试 vs 代码一致性
选择 3-5 个重要功能：
- [ ] 测试验证的行为是否与代码实现一致？
- [ ] 代码新增功能是否有对应测试？
- [ ] 代码删除功能是否删除了测试？

#### 4.2 测试 vs 文档一致性
- [ ] 测试是否验证了文档描述的关键场景？
- [ ] 文档中强调的边界条件是否有测试覆盖？
- [ ] 测试是否验证了文档未说明的隐藏行为？

**输出**：
- 不一致案例列表（文件路径 + 具体描述）
- 建议的修复方向

---

### Step 5: E2E 驱动开发就绪度

**目标**：评估是否具备 E2E 驱动开发的条件

#### 5.1 测试编写难度
- [ ] 是否容易定位 UI 元素？（data-testid 覆盖度）
- [ ] 测试数据是否容易准备？
- [ ] 测试环境是否容易启动？

#### 5.2 测试运行速度
```bash
# 测量测试运行时间
time bash scripts/test-helpers/run-e2e-test.sh
```

- [ ] 单个测试平均运行时间？
- [ ] 全量测试运行时间？
- [ ] 是否有性能优化空间？

#### 5.3 Claude Code 自主闭环能力
- [ ] 服务启动是否自动化？（./dev.sh）
- [ ] 测试运行是否自动化？（scripts/test-helpers/）
- [ ] 日志查看是否方便？（logs/）
- [ ] 错误定位是否容易？（清晰的错误消息）

**输出**：
- E2E 驱动就绪度评分：X/10
- 阻碍因素列表
- 改进建议

---

## 📊 输出格式

### 对话中展示摘要

```markdown
## E2E 测试就绪度检查摘要

**项目**：[项目名称]
**检查时间**：[日期]

---

### 📊 总体评估

| 维度 | 评分 | 状态 |
|------|------|------|
| 基础设施 | 8/10 | 🟢 良好 |
| 测试覆盖度 | 6/10 | 🟡 中等 |
| 测试质量 | 7/10 | 🟡 中等 |
| 测试-代码-文档一致性 | 8/10 | 🟢 良好 |
| E2E 驱动就绪度 | 7/10 | 🟡 中等 |
| **综合评分** | **7.2/10** | 🟡 **基本具备条件，需改进** |

---

### 🚨 关键发现

#### 测试运行结果（强制执行）
- 总测试数：23 个
- 通过：20 个 ✅
- 失败：3 个 ❌
  - tests/e2e/wechat/wechat-mp-management.e2e.test.ts:45 - timeout
  - tests/e2e/twitter/twitter-workflow.e2e.test.ts:67 - API 端点已迁移
  - tests/e2e/bili/bili-up-videos.e2e.test.ts:89 - 选择器不匹配

#### 核心功能测试覆盖
- 核心功能总数：10 个
- 有测试：7 个 ✅
- 缺失测试：3 个 ❌
  1. 咖啡系统 - 订单管理流程（优先级：中）
  2. 日志系统 - 日志查询功能（优先级：低）
  3. Twitter - 用户关注流程（优先级：高）

---

### 💡 改进建议

#### 立即修复（高优先级）
- [ ] 修复 3 个失败的 E2E 测试
- [ ] 补充 Twitter 用户关注流程测试

#### 建议改进（中优先级）
- [ ] 提高 data-testid 覆盖度（当前 60%）
- [ ] 优化测试运行速度（当前 5 分钟）
- [ ] 统一测试数据管理

#### 长期优化（低优先级）
- [ ] 引入 Page Object 模式
- [ ] 添加视觉回归测试
```

---

### 生成文档

根据发现的问题数量：

#### 方案 A：问题较少（< 10 个）
只在对话中展示

#### 方案 B：问题较多（≥ 10 个）
生成 `TODO.md` 或更详细的报告

---

## 🎯 成功标准

本次检查完成的标准：
- [ ] 实际运行了所有 E2E 测试
- [ ] 分析了测试失败原因
- [ ] 识别了缺失测试的核心功能
- [ ] 评估了测试质量
- [ ] 给出了具体的改进建议

---

## ⚠️ 禁止行为

- ❌ 改完代码不写测试
- ❌ 写完测试不运行
- ❌ 测试失败仍交付
- ❌ 说"请用户自己测试"
- ❌ 看到"缺少XX测试" → 凭想象写测试（必须先理解代码和文档）

---

## 📚 相关文档

- **深度分析框架**：`~/.claude/frameworks/DEEP_ANALYSIS_FRAMEWORK.md`
- **全面健康检查**：`~/.claude/commands/comprehensive-health-check.md`
- **快速健康检查**：`~/.claude/commands/health-check.md`
- **项目级重构**：`~/.claude/commands/refactor-project.md`（DAG 模式）
- **模块级重构**：`~/.claude/commands/refactor-module.md`（DAG 模式）
- **测试规划**：`~/.claude/commands/test-plan.md`（DAG 模式）

---

## 开始检查

现在开始 E2E 测试就绪度检查，严格遵循"强制执行"原则：

**关键要求**：
- ✅ **必须实际运行测试**，不能只看文件
- ✅ **必须分析失败原因**，具体到文件路径和行号
- ✅ **必须给出具体修复建议**，而非泛泛而谈
- ✅ **如有参考文档 DOC_DRIVEN_E2E_METHODOLOGY.md，优先参考**
