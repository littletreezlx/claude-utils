# 功能方案设计

## 目标
通过精准问题快速洞察用户真实需求，输出可直接执行的功能实现方案。

## 执行方式

### 第一阶段：需求洞察（1-3 轮对话）

**理解需求：**
- 提出 2-3 个关键问题聚焦核心价值
- 用具体场景假设验证理解
- 明确功能边界和不做事项

**审查现有设计（重要！）：**
- 如果涉及修改现有功能，先检查相关设计决策是否仍然适用
- 项目背景是否发生变化（如：单用户→多用户、本地→云端）
- 发现 TODO.md 或代码注释中的设计决策与当前需求冲突时，**主动询问用户**而非盲目遵循旧决策
- 用通俗语言向用户解释冲突点，让用户做出判断

**系统级变更的影响分析（重要！）：**

当需求涉及系统级变更（如多用户改造、权限系统、数据隔离）时，必须：

1. **全量扫描受影响模块** — 不要只看明显的表/服务，要检查：
   - 所有数据表（包括状态表、配置表、统计表）
   - 所有服务层文件（检查依赖关系）
   - 相关的路由和中间件

2. **列出完整清单让用户确认** — 格式如下：
   ```
   本次变更会影响以下模块，请确认：

   数据层：
   - [ ] User 表 — 新增
   - [ ] Role 表 — 添加 userId 字段
   - [ ] Session 表 — 添加 userId 字段
   - [ ] GlobalState 表 — 需要改为按用户隔离吗？

   服务层：
   - [ ] role.service.ts — 添加 userId 参数
   - [ ] global-role-state.service.ts — 依赖 role.service，需要同步改造吗？
   ```

3. **对不确定的模块主动提问** — 宁可多问，不要遗漏

### 第二阶段：方案输出

```
## 需求画像
- **核心功能**：一句话描述
- **关键场景**：2-3 个用户故事
- **成功标准**：如何验证功能完成

## 影响范围（系统级变更时必填）
| 模块 | 变更内容 | 用户确认 |
|------|----------|----------|

## 设计决策变更（如有）
| 原决策 | 新决策 | 变更原因 |
|--------|--------|----------|

## 架构设计
- **模块划分**：UI / 业务逻辑 / 数据层
- **接口定义**：关键 API 签名
- **复用分析**：现有代码复用点

## 实施路径
1. [步骤1] - 可独立验证
2. [步骤2] - 可独立验证
3. ...（3-5 步）

## 风险与应对
| 风险 | 应对方案 |
|------|---------|
```

## 约束条件
- **禁止过度设计**：不为假想需求抽象
- **禁止技术炫技**：选最简单能工作的方案
- **禁止大拆大建**：渐进改进优于破坏性重构
- **禁止盲从旧决策**：项目背景变化时，旧设计可能不再适用
- **禁止遗漏模块**：系统级变更必须全量扫描，列清单让用户确认
- 遵循项目现有技术栈和代码规范

## UI 项目补充
如果涉及界面修改，先查阅项目目录下的 `UI_SHOWCASE.md`（如有），结合现有组件和设计规范讨论。

## 后续衔接
- 复杂任务 → `/todo-huge-task` 任务拆分
- 方案确定 → 直接开始实现
