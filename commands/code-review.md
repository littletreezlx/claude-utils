---
description: 代码审查与提测单生成 ultrathink

---

# 代码审查

> 自动化执行 Feature Branch 代码审查，生成技术评审报告和 QA 提测单。

---

## 执行步骤

### Step 1: 智能获取变更

执行以下命令获取变更上下文（注意过滤噪音）：

```bash
# 1. 获取变更统计
git diff master...HEAD --stat

# 2. 获取核心代码变更 (排除锁文件和资源文件)
# 注意：如果输出过长，优先关注业务逻辑文件
git diff master...HEAD -- . ':(exclude)package-lock.json' ':(exclude)yarn.lock' ':(exclude)*.lock' ':(exclude)*.svg' ':(exclude)*.min.js' ':(exclude)Podfile.lock'
```

**Token 熔断策略**：如果 Diff 内容超过 1000 行，优先审查核心业务逻辑代码（*.kt, *.ts, *.py, *.java），跳过样式文件（*.css, *.scss）和配置文件。

### Step 2: 深度审查

对变更代码进行分析，关注以下维度：

| 维度 | 检查点 | 验证手段 |
| --- | --- | --- |
| **完整性** | 新增逻辑是否闭环？ | 🕵️ 怀疑未使用时，**必须**用 `grep` 全局搜索确认 |
| **健壮性** | 空指针、数组越界、异常捕获 | 检查代码逻辑分支 |
| **安全性** | SQL注入、敏感信息硬编码 | 关键词扫描 |
| **规范性** | 命名风格、注释质量 | 静态分析 |

### Step 3: 问题分级

按以下标准分类问题：

#### 🔴 严重（必须修复，阻塞合并）

符合以下**任一条件**即为严重：
- **功能缺失**：定义了但未使用的字段/函数，导致 UI 显示异常或功能不完整
- **逻辑错误**：条件判断错误、数据处理错误、状态管理错误
- **必现 Bug**：每次执行都会触发的问题，而非边缘情况
- **数据安全**：可能导致数据丢失、数据错误、数据泄露

#### 🟡 中等（建议修复，不阻塞合并）

符合以下条件：
- **潜在风险**：特定条件下可能出问题，但不是必现
- **可读性差**：魔法数字、命名不清、逻辑绕
- **规范问题**：代码格式、注释缺失、架构不一致
- **维护成本**：重复代码、过度耦合

#### 🟢 轻微（可选优化）

- 命名可以更好
- 可以更简洁
- 代码风格偏好

### Step 4: 生成双文档

生成两份文档到 `docs/` 目录。

---

## 输出文档格式

### 📄 文档 1：技术审查报告

**路径**: `docs/reviews/review-{branch}-{date}.md`
**侧重**: 代码质量、Bug 风险

```markdown
# 代码审查报告

**分支**: xxx | **日期**: xxx | **审查人**: Claude Code

## 1. 变更概览
- 文件数/行数统计
- 主要功能变更点

## 2. 问题清单

### 🔴 严重问题 (Blocker)
> 导致崩溃、逻辑错误、数据丢失的问题

#### 2.x [问题标题]
**文件**: `文件路径:行号`
**问题**: 具体描述
**为什么严重**: 解释影响
**修复建议**: 具体方案或代码示例

### 🟡 改进建议 (Warning)
> 可读性、规范性、潜在风险

### 🟢 最佳实践 (Praise)
> 值得鼓励的写法

## 3. 总体评估
- 代码质量评分（1-10）
- 是否建议合并
- 合并前必须处理的清单
```

### 📄 文档 2：QA 提测单

**路径**: `docs/reviews/test-submission-{branch}-{date}.md`
**侧重**: 功能影响、测试范围

```markdown
# 提测单

**分支**: xxx | **日期**: xxx

## 1. 变更模块

| 模块 | 类型 | 影响描述 |
|------|------|----------|
| 订单 | 修复 | 修复了金额计算精度的 bug |
| 用户 | 新增 | 增加了微信登录入口 |

## 2. 具体变更内容

### [模块名]
- 新增：xxx
- 修改：xxx
- 修复：xxx

## 3. 测试入口

说明如何进入测试该功能

## 4. 风险提示

- 需要特别关注的场景
- 已知限制

## 5. 部署注意事项 (Ops) ⚠️

- [ ] SQL 变更: `migrations/001_xxx.sql`
- [ ] 环境变量: 新增 `WECHAT_APP_ID`
- [ ] 第三方服务: 需要确认 xxx 服务可用
```

---

## 审查红线

1. **严禁臆测**：如果看不懂代码意图，标记为 "❓ 疑问" 而不是 "❌ 错误"。
2. **验证引用**：标记 "Dead Code" 前必须全局搜索确认。
3. **保持礼貌**：评论针对代码而非人。
