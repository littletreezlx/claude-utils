# 大任务智能拆分与 DAG 编排

## 核心目标
将复杂任务智能拆分为 DAG 编排的多阶段执行计划，输出 `batchcc.py` 可执行的任务文件。

## 输入方式
```bash
/todo-huge-task "实现完整的用户管理系统"
/todo-huge-task $ARGUMENTS
```

---

## 🤖 自主执行原则

**⛔ 强制前置阅读**：执行任何操作前，必须先阅读 @templates/workflow/DAG_TASK_FORMAT.md 的"自主执行原则"章节，否则禁止继续。

**核心**：DAG 任务 = 完全自动化、无人值守执行

✅ **应该做**：自主分析 → 自主决策 → 直接执行 → 记录理由
❌ **不应该**：询问用户、列选项、等待确认

**决策失败时**：标记任务 `failed`，说明原因和可选方案

---

## 执行策略

### 1. 理解任务全貌
- 核心目标是什么？
- 涉及哪些功能模块？
- 需要哪些基础设施？
- 有哪些技术约束？

### 2. 识别自然阶段

| 阶段 | 典型任务 | 执行模式 |
|------|---------|---------|
| 基础设施 | 数据库 schema、配置、第三方服务 | 串行 |
| 业务模块 | 用户、订单、支付等独立模块 | **并行** |
| 前端页面 | 各功能模块的 UI（可用 mock） | **并行** |
| 集成测试 | 模块间集成、API 联调 | 部分串行 |
| E2E 测试 | 完整业务流程验证 | **并行** |

### 3. 任务拆分原则

**粒度**：
- ✅ 功能模块级（model + service + controller + 测试）
- ❌ 太细（单文件）或太粗（整个系统）

**文件范围**：必须详细标注，用于自动冲突检测

**任务描述**：
- **📖 背景**：为什么做
- **🔨 要做什么**：3-5 步
- **✅ 完成标志**：如何验证

### 4. 输出格式

生成到项目根目录的 `todo-task` 文件：

```markdown
## STAGE ## name="阶段名" mode="serial|parallel" max_workers="4"
# 🎯 阶段目标 / 📥 输入 / 📤 输出

## TASK ##
任务标题

**📖 背景**：...
**🔨 要做什么**：...
**✅ 完成标志**：...

文件: src/modules/user/**/*.ts
排除: src/common/
验证: npm test -- user
```

> 详细格式参见 @templates/workflow/DAG_TASK_FORMAT.md

---

## 适用场景判断

### ✅ 适合 /todo-huge-task
- 多模块功能开发（用户、订单、支付等）
- 大规模重构（多个独立模块）
- 完整系统开发（前后端 + 测试）
- 数据迁移项目

### ❌ 不适合（用 /todo-write）
- 严格串行任务（无法并行）
- 高度耦合（都修改同一文件）
- 任务数 < 3 个
- 需要大量人工决策

---

## 💎 严格禁止

1. **内嵌详细示例** ⛔ - 每个 TASK 描述 20-40 行
2. **硬编码具体命令** ⛔ - 让 AI 根据项目配置查找
3. **过度详细步骤** ⛔ - 描述目标和方法，而非具体步骤

---

## 执行前输出

```markdown
✅ 任务文件已生成: ./todo-task

📊 执行计划:
- 总阶段数: [N] / 总任务数: [M]
- 可并行任务: [Y] ([Y/M]%)

🚀 下一步:
python batchcc.py todo-task --dry-run  # 预览
python batchcc.py todo-task            # 执行
```

---

## 相关文档
- @templates/workflow/DAG_TASK_FORMAT.md - 详细格式规范
- @templates/workflow/DAG_TASK_TEMPLATE.md - 空白模板
- `/todo-write` - 简单串行任务
