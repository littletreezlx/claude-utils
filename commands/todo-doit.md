# 会话恢复与任务执行

## 核心目标
读取 TODO.md 的"下一步行动"，自主执行任务，完成后更新 TODO.md，支持脚本连续调用自动完成大任务。

## ⚠️ 自动化执行要求

### 🚫 禁止行为
- **禁止询问用户** - 必须完全自主决策和执行
- **禁止跳过更新 TODO.md** - 每次执行后必须更新
- **禁止强行继续** - 任务完成时明确停止
- **禁止反复失败** - 失败3次立即停止并记录

### ✅ 必须遵守
- **读取"下一步行动"** - 这是执行的唯一依据
- **执行完成后立即更新 TODO.md** - 标记完成 + 设置新的下一步
- **任务完成时明确停止** - 标记 "✅ 所有任务已完成"
- **失败即停止** - 失败3次立即停止，记录问题到 TODO.md

## 执行流程

### 1. 读取 TODO.md

**首要任务**：读取项目根目录的 `TODO.md` 文件

**如果不存在**：
- 提示：这是新会话，没有待办任务
- 建议使用 `/todo-write` 创建任务清单
- **停止执行**

**如果存在**：继续下一步

### 2. 解析"下一步行动"

**查找"## 🎯 下一步行动"章节**：

- **如果是 "✅ 所有任务已完成"**：
  - 输出：所有任务已完成，无需继续执行
  - **停止执行**

- **如果有明确任务**：
  - 解析任务描述和验收标准
  - 查找相关文件路径
  - 理解任务上下文（从"当前工作"和"关键上下文"）
  - **继续执行**

- **如果格式不清晰**：
  - 提示：TODO.md 格式不标准，请使用 `/todo-write` 更新
  - **停止执行**

### 3. 执行任务

**执行原则**：
- 遵循 CLAUDE.md 的所有开发规范
- 完全自主执行，不询问用户
- 根据验收标准判断是否完成
- 失败时记录问题，不反复尝试

**执行步骤**：
1. 理解任务目标和验收标准
2. 检查相关文件和代码状态
3. 执行必要的代码变更
4. 运行相关测试验证
5. 确认验收标准是否满足

**失败处理**：
- 第1次失败：分析原因，尝试修复
- 第2次失败：换一个思路，再次尝试
- 第3次失败：停止执行，记录问题到 TODO.md
  ```markdown
  ## 🎯 下一步行动
  ⚠️ 任务执行失败 - 需要人工介入

  **失败任务**: [任务描述]
  **失败原因**: [具体原因]
  **已尝试方案**: [列出已尝试的方法]
  **建议**: [给开发者的建议]
  ```

### 4. 更新 TODO.md（必须执行）

**任务成功完成后**：

1. **标记当前任务完成**：
   - 将"下一步行动"中的任务移到"本次完成"
   - 添加时间戳：`- [x] [任务] - [YYYY-MM-DD HH:mm]`

2. **识别下一个任务**：
   - 从"待办任务 → 高优先级"中选择第一个
   - 如果高优先级为空，选择"普通优先级"第一个
   - 如果所有任务完成，设置为 "✅ 所有任务已完成"

3. **更新"下一步行动"**：
   - 将选中的下一个任务移到"下一步行动"
   - 从原位置删除该任务
   - 保持格式一致

4. **更新"当前工作"**（如果需要）：
   - 如果下一步任务属于新的功能模块，更新工作重点

**示例更新**：

```markdown
# 更新前
## 🎯 下一步行动
- [ ] 实现用户登录功能 - 完成 API 和前端页面
  - 验收标准: 测试通过

## 待办任务
### 高优先级
- [ ] 实现用户注册功能
- [ ] 添加密码加密

# 更新后
## 🎯 下一步行动
- [ ] 实现用户注册功能
  - 验收标准: [明确标准]

## 本次完成
- [x] 实现用户登录功能 - 2025-11-09 14:30

## 待办任务
### 高优先级
- [ ] 添加密码加密
```

### 5. 完成报告

**输出简洁的完成报告**：

```
✅ 任务完成: [任务描述]
📝 变更文件:
   - src/xxx.ts
   - tests/xxx.test.ts
🎯 下一步: [下一个任务] 或 "所有任务已完成"
```

## 状态确认（可选）

**仅在怀疑状态不一致时执行**：
- 运行 `git status` 检查未提交的变更
- 如果 git 状态与 TODO.md 记录严重不符，提示用户确认

**正常情况下**：直接信任 TODO.md，不做额外确认

## 执行原则

### 🎯 核心原则
- **理解优先**: 先充分理解任务目标和验收标准
- **自主执行**: 完全不依赖用户输入，自主决策
- **及时更新**: 任务完成立即更新 TODO.md
- **明确停止**: 完成时明确标记，不强行继续
- **失败即停**: 3次失败立即停止，不浪费时间

### 📋 自动化友好
- **标准化格式**: 严格遵循 TODO.md 格式规范
- **可预测行为**: 每次执行都遵循相同流程
- **幂等性**: 重复执行同一任务不会产生副作用
- **状态可追踪**: 通过 TODO.md 完整记录执行历史

### ⚡ 效率优化
- **并行工具调用**: 需要读取多个文件时并行调用
- **优先查阅功能映射**: 快速定位代码位置
- **场景驱动导航**: 使用 docs/INDEX.md 找到相关文档
- **Git 优先**: 遇到问题立即 git reset，不在错误基础上继续

## 约束条件

- **TODO.md 不存在** → 提示用户使用 `/todo-write`，停止执行
- **TODO.md 格式不清晰** → 提示用户更新格式，停止执行
- **所有任务已完成** → 明确告知，停止执行
- **失败3次** → 记录问题到 TODO.md，停止执行
- **不要盲目执行** → 理解任务目标，确认验收标准

## 脚本连续调用示例

```bash
# 脚本可以这样循环调用
while true; do
    claude-code /todo-doit

    # 检查 TODO.md 是否所有任务完成
    if grep -q "✅ 所有任务已完成" TODO.md; then
        echo "所有任务已完成"
        break
    fi

    # 检查是否有失败标记
    if grep -q "⚠️ 任务执行失败" TODO.md; then
        echo "任务执行失败，需要人工介入"
        break
    fi

    sleep 5  # 防止过快调用
done
```
