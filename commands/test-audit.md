---
description: æµ‹è¯•åŸºç¡€è®¾æ–½å®¡è®¡ä¸ä¿®å¤ ultrathink

---

# æµ‹è¯•åŸºç¡€è®¾æ–½å®¡è®¡ä¸ä¿®å¤

> å®¡è®¡å½“å‰é¡¹ç›®çš„æµ‹è¯•æ–¹æ¡ˆï¼Œç›´æ¥ä¿®å¤ç¼ºå¤±çš„é…ç½®å’Œè„šæœ¬

## ä½¿ç”¨æ–¹å¼

```bash
/test-audit                    # å®¡è®¡å¹¶ä¿®å¤å½“å‰é¡¹ç›®
/test-audit $ARGUMENTS         # æŒ‡å®šå…³æ³¨ç‚¹ï¼ˆunit/integration/e2eï¼‰
```

---

## æ ¸å¿ƒåŸåˆ™

1. **å®¡è®¡å³ä¿®å¤** - å‘ç°é—®é¢˜ç›´æ¥è§£å†³ï¼Œä¸è¯¢é—®
2. **å…¨ç±»å‹è¦†ç›–** - å•å…ƒ/é›†æˆ/E2E æµ‹è¯•éƒ½è¦æ£€æŸ¥
3. **æŠ€æœ¯æ ˆé€‚é…** - æ ¹æ®é¡¹ç›®ç±»å‹é€‰æ‹©æ–¹æ¡ˆ
4. **å€Ÿé‰´æˆç†Ÿé¡¹ç›®** - å‚è€ƒ nas-server ç­‰å·²æœ‰æ–¹æ¡ˆ

---

## æ‰§è¡Œæµç¨‹

### ç¬¬ä¸€æ­¥ï¼šè¯†åˆ«é¡¹ç›®ç±»å‹

| æ ‡è¯†æ–‡ä»¶ | é¡¹ç›®ç±»å‹ | ç‰¹æ®Šå¤„ç† |
|----------|----------|----------|
| `pubspec.yaml` | Flutter | **æ£€æŸ¥æ˜¯å¦åœ¨ flutter/ ç›®å½•ä¸‹ï¼Œä½¿ç”¨ç»Ÿä¸€æµ‹è¯•è„šæœ¬** |
| `package.json` + `src/` | Node.js | æ ‡å‡†å¤„ç† |
| `pyproject.toml` | Python | æ ‡å‡†å¤„ç† |
| `server/` + `app/` | å…¨æ ˆ | åˆ†åˆ«å¤„ç† |

### ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥æµ‹è¯•è„šæœ¬

#### â­ Flutter é¡¹ç›®ç‰¹æ®Šå¤„ç†

**æ£€æµ‹æ¡ä»¶**ï¼š
- å­˜åœ¨ `pubspec.yaml`
- é¡¹ç›®è·¯å¾„åŒ…å« `flutter/` ç›®å½•ï¼ˆå¦‚ `/path/to/flutter/flametree_pick`ï¼‰

**æµ‹è¯•è„šæœ¬ä½ç½®**ï¼š
- **ä¼˜å…ˆä½¿ç”¨**ï¼š`../../scripts/test.sh`ï¼ˆä¸Šå±‚ç»Ÿä¸€è„šæœ¬ï¼‰
- **E2E ä½¿ç”¨**ï¼š`../../scripts/run-e2e.sh`

**æ£€æŸ¥é¡¹ç›®æœ¬åœ°è„šæœ¬ç›®å½•**ï¼š
```bash
# æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¿‡æ—¶çš„æœ¬åœ°æµ‹è¯•è„šæœ¬
ls scripts/run_tests.sh scripts/quick_test.sh scripts/enhanced_test_runner.sh 2>/dev/null

# å¦‚æœå­˜åœ¨ï¼Œå»ºè®®å½’æ¡£åˆ° scripts/archive/
```

**Flutter é¡¹ç›®å¿…é¡»æ£€æŸ¥çš„é¡¹ç›®**ï¼š

1. **ä¸Šå±‚ç»Ÿä¸€è„šæœ¬å­˜åœ¨**ï¼š
   ```bash
   # æ£€æŸ¥ä¸Šå±‚è„šæœ¬
   test -f ../../scripts/test.sh && echo "âœ“ ç»Ÿä¸€æµ‹è¯•è„šæœ¬å­˜åœ¨"
   test -f ../../scripts/run-e2e.sh && echo "âœ“ ç»Ÿä¸€E2Eè„šæœ¬å­˜åœ¨"
   ```

2. **æœ¬åœ°è„šæœ¬æ— å†²çª**ï¼š
   - æœ¬åœ° `scripts/` ä¸åº”åŒ…å« `run_tests.sh`ã€`quick_test.sh` ç­‰é€šç”¨æµ‹è¯•è„šæœ¬
   - åº”åªä¿ç•™é¡¹ç›®ç‰¹å®šè„šæœ¬ï¼ˆå¦‚ `start-dev.sh`ã€`dev-screenshot.sh`ï¼‰

3. **é¡¹ç›®æ–‡æ¡£ä¸€è‡´æ€§**ï¼š
   ```bash
   # æ£€æŸ¥ CLAUDE.md æ˜¯å¦å¼•ç”¨ç»Ÿä¸€æµ‹è¯•è„šæœ¬
   grep "../scripts/test.sh" CLAUDE.md
   ```

**ç¼ºå¤±æ—¶çš„å¤„ç†**ï¼š

```bash
# å¦‚æœä¸Šå±‚ç»Ÿä¸€è„šæœ¬ä¸å­˜åœ¨ï¼Œåˆ›å»ºç›®å½•ç»“æ„
mkdir -p ../../scripts

# æç¤ºç”¨æˆ·éœ€è¦åˆ›å»ºç»Ÿä¸€æµ‹è¯•è„šæœ¬
echo "âš ï¸ ç¼ºå°‘ä¸Šå±‚ç»Ÿä¸€æµ‹è¯•è„šæœ¬ï¼Œéœ€è¦åˆ›å»ºï¼š"
echo "  - ../../scripts/test.sh"
echo "  - ../../scripts/run-e2e.sh"
```

#### å…¶ä»–é¡¹ç›®ç±»å‹æ£€æŸ¥

**package.json scripts æˆ–ç­‰æ•ˆé…ç½®ï¼š**

```json
{
  "test": "...",                    // åŸºç¡€æµ‹è¯•å‘½ä»¤
  "test:unit": "...",               // å•å…ƒæµ‹è¯•
  "test:integration": "...",        // é›†æˆæµ‹è¯•
  "test:e2e": "...",                // E2E æµ‹è¯•
  "test:watch": "...",              // ç›‘å¬æ¨¡å¼
  "test:coverage": "..."            // è¦†ç›–ç‡
}
```

**E2E æµ‹è¯•è„šæœ¬æ ¸å¿ƒåŠŸèƒ½ï¼š**
- [ ] è¿›ç¨‹æ¸…ç†ï¼ˆæ®‹ç•™è¿›ç¨‹å¯¼è‡´æµ‹è¯•å¤±è´¥ï¼‰
- [ ] ä¾èµ–æœåŠ¡ç®¡ç†ï¼ˆåç«¯/æ•°æ®åº“å¯åŠ¨ï¼‰
- [ ] æ™ºèƒ½è¾“å‡ºï¼ˆæˆåŠŸé™é»˜ï¼Œå¤±è´¥æ˜¾ç¤ºè¯¦æƒ…ï¼‰
- [ ] æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ

**æµ‹è¯•ç»“æ„å¥åº·æ£€æŸ¥ï¼ˆæ–°å¢ï¼‰**ï¼š
- [ ] æ˜¯å¦ç¬¦åˆå†°å±±ç­–ç•¥ï¼Ÿï¼ˆå•å…ƒæµ‹è¯•å  60-80%ï¼ŒE2E å  20-40%ï¼‰
- [ ] é‡äº¤äº’åº”ç”¨æ˜¯å¦ä½¿ç”¨ Test Facade é¿å… E2E è„†å¼±æ€§ï¼Ÿ
- [ ] E2E æµ‹è¯•æ˜¯å¦é€šè¿‡ UI å‡†å¤‡æ•°æ®ï¼ˆæ…¢ä¸”è„†ï¼‰ï¼Ÿ
  - æ˜¯ â†’ å»ºè®®åˆ›å»º `integration_test/utils/test_facade.dart`
  - å¦ â†’ âœ…
- [ ] æ˜¯å¦æœ‰åº”ç”¨ç±»å‹ä¸åŒ¹é…çš„æµ‹è¯•ï¼Ÿ
  - é‡é€»è¾‘åº”ç”¨ç”¨ Golden Test â†’ åº”æ”¹ç”¨ Unit Test
  - é‡è¡¨ç°åº”ç”¨è¿‡åº¦æµ‹è¯• â†’ å¯ç®€åŒ–æˆ–åˆ é™¤

#### ç¼ºå¤±æ—¶çš„å¤„ç†

**ä¸ä½¿ç”¨æ¨¡æ¿** - ç›´æ¥æ ¹æ®é¡¹ç›®å®é™…æƒ…å†µç”Ÿæˆï¼š
1. è¯»å–é¡¹ç›®ç»“æ„
2. è¯†åˆ«æµ‹è¯•æ¡†æ¶
3. ç”Ÿæˆé€‚é…çš„è„šæœ¬
4. æ›´æ–°é…ç½®æ–‡ä»¶

### ç¬¬ä¸‰æ­¥ï¼šéªŒè¯æµ‹è¯•å¯è¿è¡Œ

```bash
# Flutter é¡¹ç›®ï¼ˆä½¿ç”¨ç»Ÿä¸€è„šæœ¬ï¼‰
../../scripts/test.sh 2>&1 | head -20

# Node.js (Jest/Vitest)
npm test -- --passWithNoTests --forceExit 2>&1 | head -20

# Python
pytest --collect-only 2>&1 | head -20
```

### ç¬¬å››æ­¥ï¼šCI/CD å…¼å®¹æ€§æ£€æŸ¥

> æœ¬åœ°è·‘é€š â‰  CI è·‘é€šï¼Œç¯å¢ƒå·®å¼‚æ˜¯å¸¸è§é—®é¢˜

**æ£€æŸ¥æ–‡ä»¶**ï¼š
- `.github/workflows/*.yml`
- `.gitlab-ci.yml`
- `Jenkinsfile`
- `.circleci/config.yml`

**å¸¸è§é—®é¢˜æ’æŸ¥**ï¼š

| é—®é¢˜ | æœ¬åœ° vs CI | ä¿®å¤æ–¹å¼ |
|------|-----------|---------|
| ç¯å¢ƒå˜é‡ç¼ºå¤± | æœ¬åœ°æœ‰ `.env` | CI ä¸­æ·»åŠ  secrets/å˜é‡ |
| `CI=true` è¡Œä¸ºå·®å¼‚ | Jest äº¤äº’æ¨¡å¼ | è„šæœ¬ä¸­æ˜¾å¼è®¾ç½® `CI=true` |
| æµè§ˆå™¨ç¼ºå¤± | æœ¬åœ°æœ‰ Chrome | CI ä¸­æ·»åŠ  `npx playwright install` |
| æ—¶åŒº/Locale | æœ¬åœ°ä¸­æ–‡ | CI ä¸­è®¾ç½® `TZ=UTC` |
| å¹¶å‘å†²çª | å•ç”¨æˆ·æœ¬åœ° | CI ä¸­éš”ç¦»æµ‹è¯•æ•°æ®åº“ |
| Flutter SDK | æœ¬åœ°æœ‰ flutter | CI ä¸­æ·»åŠ  `flutter: sdk: flutter` |

**æ£€æŸ¥é¡¹**ï¼š
- [ ] CI é…ç½®ä¸­çš„æµ‹è¯•å‘½ä»¤ä¸æœ¬åœ°ä¸€è‡´
- [ ] ç¯å¢ƒå˜é‡åœ¨ CI secrets ä¸­å·²é…ç½®
- [ ] ä¾èµ–å®‰è£…æ­¥éª¤å®Œæ•´ï¼ˆå« dev dependenciesï¼‰
- [ ] E2E æµ‹è¯•æœ‰æµè§ˆå™¨å®‰è£…æ­¥éª¤ï¼ˆé Flutterï¼‰
- [ ] Flutter CI é…ç½®åŒ…å« `submodule` æ›´æ–°ï¼ˆflutter_commonï¼‰

**å‘ç°é—®é¢˜æ—¶**ï¼šç›´æ¥ä¿®å¤ CI é…ç½®æ–‡ä»¶ï¼Œæˆ–åœ¨è¾“å‡ºä¸­æ³¨æ˜"CI é…ç½®éœ€è¦æ›´æ–°"ã€‚

### ç¬¬äº”æ­¥ï¼šæ›´æ–°é¡¹ç›®æ–‡æ¡£

åœ¨ `CLAUDE.md` æ·»åŠ /æ›´æ–°æµ‹è¯•å‘½ä»¤éƒ¨åˆ†ã€‚

**Flutter é¡¹ç›®æ–‡æ¡£æ ¼å¼**ï¼š
```markdown
## æµ‹è¯•å‘½ä»¤

```bash
# å•å…ƒæµ‹è¯•ï¼ˆAI å‹å¥½ï¼‰
../scripts/test.sh                           # å…¨é‡æµ‹è¯•
../scripts/test.sh test/unit/xxx_test.dart   # å•æ–‡ä»¶æµ‹è¯•
../scripts/test.sh test/unit/domain/         # ç›®å½•çº§æµ‹è¯•

# E2E/é›†æˆæµ‹è¯•
../scripts/run-e2e.sh                        # å…¨é‡ E2E
../scripts/run-e2e.sh integration_test/xxx.dart  # å•æ–‡ä»¶ E2E
```
```

---

## æŠ€æœ¯æ ˆæ–¹æ¡ˆå‚è€ƒ

### â­ Flutter é¡¹ç›®ï¼ˆç»Ÿä¸€æµ‹è¯•è„šæœ¬ï¼‰

**å…³é”®ç‚¹**ï¼š
- **ç»Ÿä¸€å…¥å£**ï¼šæ‰€æœ‰ Flutter å­é¡¹ç›®å…±ç”¨ `../../scripts/test.sh`
- **AI å‹å¥½è¾“å‡º**ï¼šç²¾ç®€è¾“å‡ºæ ¼å¼ï¼ŒæˆåŠŸæ˜¾ç¤ºæ‘˜è¦ï¼Œå¤±è´¥æ˜¾ç¤ºè¯¦æƒ…
- **ç²¾å‡†æµ‹è¯•**ï¼šæ”¯æŒå•æ–‡ä»¶ã€ç›®å½•çº§æµ‹è¯•
- **E2E åˆ†ç¦»**ï¼š`run-e2e.sh` å•ç‹¬å¤„ç†é›†æˆæµ‹è¯•

**è„šæœ¬åŠŸèƒ½**ï¼š
```bash
# å•å…ƒæµ‹è¯•
../../scripts/test.sh                           # å…¨é‡
../../scripts/test.sh test/unit/xxx_test.dart   # å•æ–‡ä»¶
../../scripts/test.sh test/unit/domain/         # ç›®å½•

# E2E æµ‹è¯•
../../scripts/run-e2e.sh                        # å…¨é‡
../../scripts/run-e2e.sh integration_test/xxx.dart  # å•æ–‡ä»¶
```

**è¾“å‡ºæ ¼å¼**ï¼ˆAI å‹å¥½ï¼‰ï¼š
```
âœ“ å…¨éƒ¨é€šè¿‡ (N ä¸ªæµ‹è¯•)
```
æˆ–
```
âœ— å¤±è´¥ (X ä¸ªæµ‹è¯•)
- test/unit/xxx_test.dart: æµ‹è¯•åç§°
  Error: é”™è¯¯ä¿¡æ¯
```

**é¡¹ç›®æœ¬åœ°è„šæœ¬ä¿ç•™**ï¼š
- `start-dev.sh` - å¯åŠ¨å¼€å‘ç¯å¢ƒ
- `dev-screenshot.sh` - æˆªå›¾ç®¡ç†
- `view-dev-log.sh` - æ—¥å¿—æŸ¥çœ‹
- `coverage-exclude-generated.sh` - è¦†ç›–ç‡ï¼ˆç‰¹æœ‰åŠŸèƒ½ï¼‰

### Node.js åç«¯ï¼ˆå‚è€ƒ nas-serverï¼‰

**package.json scriptsï¼š**
```json
{
  "test": "jest --forceExit",
  "test:unit": "jest --selectProjects backend --forceExit",
  "test:integration": "jest tests/integration/ --forceExit",
  "test:e2e": "bash scripts/test-helpers/run-e2e-smart.sh",
  "test:watch": "jest --watch"
}
```

**E2E è„šæœ¬æ ¸å¿ƒé€»è¾‘ï¼š**
```bash
#!/bin/bash
set -e

# 1. æ¸…ç†æ®‹ç•™è¿›ç¨‹
pkill -f "playwright|chromium" 2>/dev/null || true

# 2. è¿è¡Œæµ‹è¯•ï¼Œè¾“å‡ºåˆ°ä¸´æ—¶æ–‡ä»¶
npx playwright test 2>&1 | tee /tmp/e2e.log
EXIT_CODE=${PIPESTATUS[0]}

# 3. æ™ºèƒ½è¾“å‡º
if [ $EXIT_CODE -eq 0 ]; then
    echo "âœ… æµ‹è¯•é€šè¿‡"
else
    echo "âŒ å¤±è´¥çš„æµ‹è¯•ï¼š"
    grep -E "(âœ—|FAIL)" /tmp/e2e.log | head -10
    echo "ğŸ’¥ é”™è¯¯ä¿¡æ¯ï¼š"
    grep -A 3 "Error:" /tmp/e2e.log | head -20
fi
```

### Python é¡¹ç›®

**pytest é…ç½®ï¼š**
```ini
# pytest.ini æˆ– pyproject.toml
[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = "test_*.py"
addopts = "-v --tb=short"
```

### å…¨æ ˆé¡¹ç›®

åˆ†åˆ«å®¡è®¡å„å­é¡¹ç›®ï¼Œå¯é€‰åˆ›å»ºå…¨é‡æµ‹è¯•è„šæœ¬ï¼š
```bash
# scripts/test-all.sh
cd server && npm test
cd ../app && flutter test
```

---

## è¾“å‡ºæ ¼å¼

```markdown
## æµ‹è¯•åŸºç¡€è®¾æ–½å®¡è®¡ç»“æœ

### é¡¹ç›®: xxx
- **ç±»å‹**: Flutter
- **è·¯å¾„**: /path/to/flutter/project
- **æµ‹è¯•è„šæœ¬**: ../../scripts/test.sh (ç»Ÿä¸€)

### å•å…ƒæµ‹è¯• âœ…
- ç»Ÿä¸€æµ‹è¯•è„šæœ¬å­˜åœ¨
- é¡¹ç›®æ–‡æ¡£å·²æ›´æ–°å¼•ç”¨

### é›†æˆæµ‹è¯• âš ï¸ å·²ä¿®å¤
- [æ›´æ–°] CLAUDE.md æµ‹è¯•å‘½ä»¤éƒ¨åˆ†

### E2E æµ‹è¯• âœ…
- ç»Ÿä¸€ E2E è„šæœ¬å­˜åœ¨
- [å½’æ¡£] scripts/run_tests.sh â†’ archive/

### CI/CD å…¼å®¹æ€§ âš ï¸ éœ€å…³æ³¨
- [æ£€æŸ¥] .github/workflows/test.yml
- [é—®é¢˜] éœ€æ·»åŠ  flutter_common submodule æ›´æ–°

### å·²æ›´æ–°æ–‡æ¡£
- CLAUDE.md æµ‹è¯•å‘½ä»¤éƒ¨åˆ†
- scripts/README.md
```

---

## ç¦æ­¢äº‹é¡¹

1. **ä¸ä½¿ç”¨æ¨¡æ¿æ–‡ä»¶** - æ ¹æ®é¡¹ç›®å®é™…æƒ…å†µç”Ÿæˆ
2. **ä¸è¯¢é—®æ˜¯å¦ä¿®å¤** - ç›´æ¥ä¿®å¤
3. **ä¸ç”ŸæˆæŠ¥å‘Šæ–‡ä»¶** - åªåœ¨å¯¹è¯ä¸­è¾“å‡º
4. **ä¸ä¿®æ”¹ä¸šåŠ¡ä»£ç ** - åªå¤„ç†æµ‹è¯•åŸºç¡€è®¾æ–½
5. **ä¸ä¸º Flutter åˆ›å»ºæœ¬åœ°æµ‹è¯•è„šæœ¬** - ä½¿ç”¨ä¸Šå±‚ç»Ÿä¸€è„šæœ¬

---

## å…³è”å‘½ä»¤

- `/test-plan` - è§„åˆ’æµ‹è¯•ä»»åŠ¡ï¼ˆDAG ç¼–æ’ï¼‰
- `/test-run` - è¿è¡Œæµ‹è¯•å¹¶ä¿®å¤å¤±è´¥
- `/create-e2e-test` - åˆ›å»ºæ–°æµ‹è¯•ç”¨ä¾‹
