---
description: 测试基础设施审计与修复 ultrathink
---

# 测试基础设施审计与修复

> 审计当前项目的测试方案，直接修复缺失的配置和脚本

## 使用方式

```bash
/test-audit                    # 审计并修复当前项目
/test-audit $ARGUMENTS         # 指定关注点（unit/integration/e2e）
```

---

## 核心原则

1. **审计即修复** - 发现问题直接解决，不询问
2. **全类型覆盖** - 单元/集成/E2E 测试都要检查
3. **技术栈适配** - 根据项目类型选择方案

---

## 执行流程

### 第一步：识别项目类型

根据标识文件（`pubspec.yaml`/`package.json`/`pyproject.toml`）确定项目类型和测试框架。

### 第二步：检查测试脚本

**检查项**：
- [ ] 测试命令配置完整（unit/integration/e2e/watch/coverage）
- [ ] E2E 脚本具备：进程清理、依赖服务管理、智能输出、报告生成
- [ ] 符合冰山策略（单元测试 60-80%，E2E 20-40%）
- [ ] 重交互应用是否使用 Test Facade 避免 E2E 脆弱性

**缺失时**：根据项目实际情况直接生成适配的脚本和配置。

### 第三步：验证测试可运行

执行测试命令确认环境就绪，收集前 20 行输出判断是否正常。

### 第四步：CI/CD 兼容性检查

| 常见问题 | 修复方式 |
|---------|---------|
| 环境变量缺失 | CI 中添加 secrets/变量 |
| `CI=true` 行为差异 | 脚本中显式设置 |
| 浏览器/SDK 缺失 | CI 中添加安装步骤 |
| 时区/Locale 差异 | CI 中设置 `TZ=UTC` |

### 第五步：更新项目文档

在 `CLAUDE.md` 添加/更新测试命令部分。

---

## 输出格式

```markdown
## 测试基础设施审计结果

### 项目: xxx
- **类型**: [Flutter/Node.js/Python]
- **测试框架**: [Jest/Vitest/Pytest/Flutter Test]

### 单元测试 ✅/⚠️
- [状态说明]

### E2E 测试 ✅/⚠️
- [状态说明]

### CI/CD ✅/⚠️
- [状态说明]

### 已修复项
- [修复内容列表]
```

---

## 禁止事项

1. **不使用模板文件** - 根据项目实际情况生成
2. **不询问是否修复** - 直接修复
3. **不生成报告文件** - 只在对话中输出
4. **不修改业务代码** - 只处理测试基础设施

---

## 相关文档

- `/test-plan` - 测试规划（DAG 编排）
- `/test-run` - 运行测试并修复失败
- `/create-e2e-test` - 创建新测试用例
