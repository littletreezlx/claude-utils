# 命令设计指南

> 指导 Claude Code 如何编写和优化斜杠命令

## 🚀 速查表

| 我要做什么 | 参考文档 |
|----------|---------|
| 查看命令列表 | @README.md |
| 编写新命令 | 本文档 |
| 了解 DAG 系统 | @templates/workflow/DAG_TASK_FORMAT.md |
| DAG 任务示例 | @templates/workflow/DAG_EXAMPLE_*.md |

---

## ⭐ 核心设计原则

### 四大理念

1. **意图清晰** - 明确表达要解决的核心问题
2. **执行自主** - 告诉 AI "做什么"和"为什么"，而非"怎么做"
3. **约束平衡** - 必要的规范 + 充分的自由
4. **务实导向** - 简单够用 > 复杂完美

### 质量标准

- 文件精简（建议 100 行以下，非硬性）
- 职责单一（一个命令解决一类问题）
- 目标明确（清晰的问题定义和期望输出）
- 无重复（与其他命令职责不重叠）

---

## 📝 命令编写指导

### 推荐结构

```markdown
# 命令名

## 目标
一句话说明这个命令解决什么问题

## 执行方式
提供方法指导（而非具体步骤）：
- 分析什么
- 关注什么
- 生成什么

## 约束条件
- 必须遵守的规范
- 禁止的操作
- 技术要求

## 输出要求
期望的结果格式和质量标准

## 模板引用（可选）
@templates/...
```

### 编写陷阱 ❌

**1. 写成详细步骤模板**
```markdown
❌ 第一步：运行 git status
❌ 第二步：读取 package.json
✅ 应该：分析项目依赖状态，识别过时或冲突的包
```

**2. 内嵌大量示例**
```markdown
❌ 示例1：...50行代码...
✅ 应该：参考 @templates/docs/README_TEMPLATE.md
```

**3. 职责模糊**
```markdown
❌ 分析代码 + 写文档 + 运行测试 + 提交代码
✅ 应该：一个命令解决一类问题，通过组合实现复杂流程
```

**4. 过度约束**
```markdown
❌ 必须使用 prettier 格式化
❌ 注释必须超过30%
✅ 应该：遵循项目现有的代码规范和工具
```

---

## 🔄 三种工作流模式

根据任务复杂度选择合适的工作流：

| 模式 | 适用场景 | 特点 |
|------|---------|------|
| **即时执行型** | 单一操作 | 简单快速，即时反馈 |
| **串行任务型** | 2-5 个串行任务 | 支持断点续传 |
| **DAG 任务型** | ≥3 个复杂任务 | 并行执行 + 自动化编排 |

### 快速决策

```
单一操作？→ 即时执行型（/code-review, /gitcommit）
    ↓ 否
< 3 个且严格串行？→ 串行任务型（/todo-write + /todo-doit）
    ↓ 否
≥ 3 个或可并行？→ DAG 任务型（/todo-huge-task）⭐
```

### DAG 自动化保证机制

DAG 任务的核心价值是**完全自动化、无人值守**执行。

**关键机制**：`batchcc.py` 在调用 Claude 执行每个任务时，自动注入"自动化执行指示"，确保：
- 每个任务都明确告知 Claude "这是自动化任务"
- 不依赖任务文件的描述或 Claude 的"记忆"
- 系统性保证不会中途询问用户

> 详细的 DAG 格式和示例参见 @templates/workflow/DAG_TASK_FORMAT.md

---

## 🎯 DAG 命令编写规范

编写生成 DAG 任务的命令时，**必须包含以下要素**：

### 必须包含的章节

| 章节 | 说明 | 示例命令 |
|------|------|---------|
| **使用方式** | batchcc 命令示例 | `/comprehensive-health-check` |
| **生成文件结构** | 主任务 + 子文件目录 | `task-xxx` + `.xxx-tasks/` |
| **主任务文件格式** | STAGE 语法示例 | `## STAGE ## name="xxx"` |
| **子文件 TASK 格式** | ⚠️ 关键！必须有示例 | `## TASK ##` |
| **字数约束** | 防止生成冗长内容 | 单任务 15-30 行 |
| **严格禁止** | 常见错误清单 | 禁止生成报告 |

### ⚠️ 最常见错误

**生成"报告"而非"任务文件"**：

```markdown
# ❌ 错误输出（诊断报告）
## 测试现状分析
- 后端测试：15个文件，46个失败...
- 前端测试：33个文件...
## 优先级总结
## 执行建议

# ✅ 正确输出（DAG 任务文件）
## STAGE ## name="infrastructure" mode="serial"
@.test-tasks/stage-1-infrastructure.md

## STAGE ## name="test-writing" mode="parallel"
@.test-tasks/stage-2-test-writing.md
```

### 模板参考

编写 DAG 命令时，参考以下现有命令的结构：
- `@comprehensive-health-check.md` - 健康检查
- `@refactor-project.md` - 项目重构
- `@test-plan.md` - 测试规划

---

## 📋 质量检查清单

编写或优化命令时检查：

### 结构质量
- [ ] 文件精简（建议 100 行以下）
- [ ] 职责单一
- [ ] 目标明确
- [ ] 无重复

### 设计质量
- [ ] 意图清晰（一句话能说明核心目的）
- [ ] 约束适度
- [ ] 可组合
- [ ] 实用性

### 内容质量
- [ ] 无详细步骤模板
- [ ] 无大量内嵌示例
- [ ] 有清晰的输出要求
- [ ] 有必要的技术约束

---

## 🛠️ 项目约束

### 技术限制
- **禁止调用 `sleep` 命令**（会导致屏幕休眠）
- **禁止创建不必要的文件**（优先编辑现有文件）
- **禁止主动创建文档**（除非用户明确要求）

### 提交规范
- 使用约定式提交：`type(scope): description`
- 类型：feat/fix/docs/style/refactor/test/chore
- 完成完整功能后提醒用户提交

---

## 📂 目录结构

```
commands/
├── *.md                    # 命令文件
├── templates/              # 模板和规范
│   ├── docs/              # 文档模板
│   └── workflow/          # 工作流模板（DAG 格式、示例）
├── archived/               # 归档（历史决策、实验记录）
├── CLAUDE.md              # 本设计指南
└── README.md              # 命令索引和快速入门
```

**命令引用机制**：
- 参数传递：`$ARGUMENTS`
- 文件引用：`@文件名`
- 模板引用：`@templates/...`

---

## 🔧 优化方法论

优化命令时遵循：

1. **目标识别** - 这个命令真正要解决什么问题？
2. **职责分离** - 是否做了太多事？与其他命令重复？
3. **约束平衡** - 哪些约束必须？哪些应让 AI 自主决定？
4. **结构优化** - 信息是否有清晰的逻辑层次？
5. **精简表达** - 能用一句话说的不用一段话

---

**命令总数**：25 个核心命令（详见 @README.md）
**设计原则**：目标导向、自主执行、单一真相源
