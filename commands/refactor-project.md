# 项目级重构（Project-Level Refactoring）

> **用途**：系统性重构项目架构和组织结构
>
> **核心特性**：
> - ✅ DAG 任务编排（串行/并行混合执行）
> - ✅ 自动断点续传（重构被中断可自动继续）
> - ✅ 状态管理（可视化进度和耗时）
> - ✅ 预览执行计划（`--dry-run`）
>
> **适用场景**：
> - 重大架构调整
> - 模块重组
> - 技术栈升级
> - 基础设施优化

---

## 🎯 工作原理

采用 **DAG 任务编排模式**：

```
/refactor-project 分析项目
    ↓
自主决策重构方案
    ↓
生成 task-refactor-project（DAG 格式）
    ↓
输出任务文件路径和执行命令
    ↓
python batchcc.py task-refactor-project（执行）
    ↓
自动执行（支持中断和续传）：
  - STAGE 1（串行）: 基础设施准备
  - STAGE 2（并行）: 多模块重构
  - STAGE 3（串行）: 集成测试
  - STAGE 4（并行）: 文档更新
    ↓
✅ 所有阶段完成
```

---

## 🚀 使用方法

```bash
# 步骤1: 生成重构任务文件（建议先运行全面健康检查）
/comprehensive-health-check  # 可选：先诊断问题
/refactor-project

# 步骤2: 预览执行计划
python batchcc.py task-refactor-project --dry-run

# 步骤3: 执行重构（自动断点续传）
git commit -am "Before refactor"
python batchcc.py task-refactor-project

# 步骤4: 如果中断，直接再次运行（自动从断点继续）
python batchcc.py task-refactor-project

# 步骤5: 查看执行状态
cat task-refactor-project.state.json
```

---

## 🤖 自主执行原则

本命令生成的任务文件将通过 `batchcc.py` **完全自动化、无人值守**地执行。

### Claude 在项目重构任务中的行为准则

#### ✅ 应该做的
1. **自主分析**：深入理解项目架构和重构目标
2. **自主决策**：基于影响面、风险、成本选择最优重构方案
3. **直接执行**：不询问用户，直接实施选定的重构方案
4. **记录理由**：在日志和文档中说明重构决策依据
5. **风险控制**：每个阶段完成后运行测试验证

#### ❌ 不应该做的
1. 询问"应该用哪种架构模式？"
2. 列出多种重构方案让用户选择
3. 在任务中设计交互式环节

### 重构决策标准

**架构方案选择原则**：

1. **优先保持简单**：
   - 够用的简单方案 > 完美的复杂方案
   - 减少抽象层级，降低理解成本
   - 避免过度设计

2. **基于实际问题**：
   - 解决现存痛点，而非假想需求
   - 有明确的可衡量改进（性能、可维护性、可测试性）
   - 不为"可能的未来需求"而设计

3. **风险可控**：
   - 优先修改影响范围小的模块
   - 每个阶段都有测试验证
   - 保持向后兼容（除非明确要破坏性重构）

**自动决策范围**（无需询问）：

- ✅ 拆分职责混乱的大类（有明确的职责边界）
- ✅ 消除循环依赖（有明确的依赖方向）
- ✅ 重构重复代码（有明确的抽象目标）
- ✅ 优化数据流（有明确的性能问题）

**需标记失败的情况**：

- ❌ 多种架构模式同等可行（如 MVC vs MVVM）
- ❌ 需要业务规则判断（如数据迁移策略）
- ❌ 涉及重大技术栈变更（如框架替换）

**示例对比**：

❌ **错误做法**：
```
分析发现架构问题：
1. 可以用分层架构
2. 可以用六边形架构
3. 可以用微服务架构

哪种更适合这个项目？请告诉我你的选择！
```

✅ **正确做法**：
```
分析发现架构问题：
- 当前：所有逻辑混在 Controller
- 问题：难以测试、难以复用

决策：采用分层架构（Service + Repository）
理由：
- 项目规模中等，不需要复杂架构
- 分层架构简单易懂，团队熟悉
- 可以立即改善可测试性
- 未来可渐进演进到其他架构

正在实施重构...
✅ STAGE 1: 创建 Service 层
✅ STAGE 2: 重构各模块
✅ STAGE 3: 测试验证
```

**真正无法决策时**：

如需要业务知识判断，标记任务为 `failed`，说明原因和可选方案

---

## 📋 执行策略

### 核心目标

生成以下文件结构：

```
项目根目录/
├── task-refactor-project                # 主任务文件（精简，你需要生成）
├── task-refactor-project.state.json     # 状态文件（自动生成）
│
└── .refactor-tasks/                     # 重构任务细节（你需要生成）
    ├── stage-1-infrastructure.md        # 基础设施准备
    ├── stage-2-module-refactor.md       # 模块重构
    ├── stage-3-integration-test.md      # 集成测试
    └── stage-4-documentation.md         # 文档更新
```

---

## 执行步骤

### 步骤1: 全面分析项目

**分析内容**：
- 扫描项目结构和技术栈
- 读取核心文档：README.md, TECHNICAL.md, CLAUDE.md, PROJECT_STATUS.md
- 读取架构决策：docs/decisions/INDEX.md（如果存在）
- 诊断问题：模块划分、依赖关系、技术债务、基础设施

**可选**：如果用户没有运行，建议先运行 `/comprehensive-health-check` 获取详细诊断

**输出**：
- 项目现状评估
- 核心问题列表（按优先级）
- 当前架构分析

---

### 步骤2: 生成 task-refactor-project 主文件

**参考模板**：`@templates/workflow/DAG_TASK_FORMAT.md`

**任务文件结构**：

```markdown
# 项目重构任务 - [项目名]

## 项目背景
[简要说明项目情况和重构原因]

## 重构目标
[列出重构的核心目标]

## STAGE ## name="infrastructure" mode="serial"
# 🎯 阶段目标：基础设施准备
# 📥 输入：当前项目代码
# 📤 输出：基础设施就绪，可安全进行模块重构
# 🔗 为下一阶段提供：稳定的基础设施和测试环境

@.refactor-tasks/stage-1-infrastructure.md

## STAGE ## name="module-refactor" mode="parallel" max_workers="4"
# 🎯 阶段目标：并行重构多个模块
# 📥 输入：基础设施就绪
# 📤 输出：各模块重构完成，符合新架构
# 🔗 为下一阶段提供：重构后的模块代码

@.refactor-tasks/stage-2-module-refactor.md

## STAGE ## name="integration-test" mode="serial"
# 🎯 阶段目标：集成测试和验证
# 📥 输入：所有模块重构完成
# 📤 输出：集成测试通过
# 🔗 为下一阶段提供：验证通过的代码

@.refactor-tasks/stage-3-integration-test.md

## STAGE ## name="documentation" mode="parallel" max_workers="2"
# 🎯 阶段目标：更新项目文档
# 📥 输入：代码重构和测试完成
# 📤 输出：所有文档更新完成

@.refactor-tasks/stage-4-documentation.md
```

---

### 步骤3: 生成各阶段的详细任务文件

根据项目实际情况，为每个阶段生成对应的任务文件到 `.refactor-tasks/` 目录：

#### stage-1-infrastructure.md（基础设施准备）
**典型任务**：
- 设置测试环境和 CI/CD
- 创建分支保护和回滚方案
- 配置代码质量检查工具

#### stage-2-module-refactor.md（模块重构）
**典型任务**：
- 按模块并行重构（用户、订单、支付等）
- 每个模块独立的任务
- 明确文件范围，避免冲突

#### stage-3-integration-test.md（集成测试）
**典型任务**：
- 运行完整测试套件
- 性能测试和优化
- 验证重构结果

#### stage-4-documentation.md（文档更新）
**典型任务**：
- 更新 TECHNICAL.md 和架构文档
- 更新 FEATURE_CODE_MAP.md 和 PROJECT_STATUS.md
- 创建重构总结 ADR

---

## 💎 严格禁止事项

### 禁止1：内嵌详细示例 ⛔
**严格禁止**：
- ❌ 在任务文件中内嵌完整的模块重构示例（>50行）
- ❌ 内嵌多种场景的详细任务模板

**正确做法**：
- ✅ 只说明任务类型和关注点
- ✅ 让 AI 根据项目实际情况生成任务

### 禁止2：硬编码具体命令 ⛔
**严格禁止**：
- ❌ 硬编码测试命令（如 `npm test -- --testPathPattern=user`）

**正确做法**：
- ✅ 根据项目配置自动查找测试命令

### 禁止3：过度详细的步骤 ⛔
**严格禁止**：
- ❌ 编号步骤超过 5 步

**正确做法**：
- ✅ 描述重构目标和验证标准

### 📏 字数约束
**严格限制**：
- ⚠️ **单个 TASK 描述**：建议 20-40 行
- ⚠️ **每个 stage 任务文件**：建议 80-150 行

---

## 🎯 重要约束

### 1. 分析优先 ⚠️
- 充分分析现状
- 识别核心问题
- 评估重构风险

### 2. 测试驱动 ⚠️
- 每阶段完成后运行测试
- 测试不过不进入下一阶段
- 优先保证核心功能稳定

### 3. 不要过度设计 ⚠️
- **优先**：解决现有问题
- **避免**：为"可能的未来"设计
- **原则**：够用即可

### 4. Git 里程碑 ⚠️
- 重构前确保 Git 工作区干净
- 建议在 task-refactor-project 中添加提交点任务
- 方便回滚

---

## 💡 核心价值

**相比传统重构流程**：

| 传统流程 | DAG 模式 |
|---------|----------|
| ❌ 手动分阶段执行 | ✅ 自动编排执行 |
| ❌ 中断后重新开始 | ✅ 自动断点续传 |
| ❌ 串行执行效率低 | ✅ 并行重构多模块 |
| ❌ 无状态可视化 | ✅ 完整状态管理 |
| ❌ 手动跟踪进度 | ✅ 自动保存状态 |

**DAG 模式优势**：
- ✅ 重构被中断可自动继续（不浪费已完成的工作）
- ✅ 并行重构独立模块（大幅提速）
- ✅ 状态可视化（查看进度和耗时）
- ✅ 文件冲突检测（避免并发修改冲突）

---

## 📊 与其他 Commands 对比

| Command | 用途 | 范围 | 工作流 |
|---------|------|------|--------|
| `/comprehensive-health-check` | 深度诊断 | 全项目 | DAG 模式 |
| `/health-check` | 快速检查 | 全项目 | 即时执行 |
| `/refactor-project` | 系统性重构 | 全项目 | **DAG 模式** ⭐ |
| `/refactor-module` | 模块重构 | 单个模块 | **DAG 模式** ⭐ |
| `/refactor` | 简单重构 | 单个文件 | 即时执行 |

**建议顺序**：
1. 运行 `/comprehensive-health-check` 全面诊断
2. 根据诊断结果决定是否需要项目级重构
3. 如需重构，运行 `/refactor-project`

---

## 📚 相关文档

- **DAG 任务格式**：`@templates/workflow/DAG_TASK_FORMAT.md`
- **全面健康检查**：`@comprehensive-health-check.md`
- **任务工作流架构**：`@CLAUDE.md` 的"任务工作流架构"章节
- **batchcc 脚本**：`~/.claude/my-scripts/batch/README_DAG.md`

---

## 开始执行

现在开始项目级重构，采用 DAG 任务编排模式。

**执行步骤**：
1. ✅ **深入分析项目**，识别核心重构需求和风险点
2. ✅ **自主决策重构方案**，选择最优架构模式
3. ✅ **生成任务文件**（task-refactor-project + .refactor-tasks/*.md）
4. ✅ **输出任务文件路径和执行命令**

**生成的任务文件将通过 `batchcc.py` 完全自动化执行**，无需人工干预。

**关键要求**：
- ✅ 使用 DAG 格式生成任务文件
- ✅ 任务文件模块化（使用 `@文件引用`）
- ✅ 明确的 STAGE 编排（串行/并行）
- ✅ 每个 TASK 有清晰的背景、目标、验证标准
- ✅ 文件范围明确（支持冲突检测）
- ✅ 验证命令完整且可自动执行
