---
description: 项目级重构（DAG 编排）ultrathink

---

# 项目级重构（DAG 编排）

> 系统性重构项目架构，支持并行执行和断点续传

## 核心价值
- 🔄 自动断点续传（重构被中断可继续）
- ⚡ 并行重构独立模块（大幅提速）
- 📊 状态可视化（进度和耗时）
- 🛡️ 文件冲突检测（避免并发冲突）

**关键约束**：任务描述要清晰简洁，目标明确可验证。

---

## 🚀 使用方式

```bash
# 1. 生成重构任务（建议先运行健康检查）
/comprehensive-health-check  # 可选：先诊断
/refactor-project

# 2. 预览执行计划
python batchcc.py task-refactor-project --dry-run

# 3. 执行（自动断点续传）
git commit -am "Before refactor"
python batchcc.py task-refactor-project
```

---

## 🤖 自主执行原则

> **⛔ 强制阅读**：@templates/workflow/DAG_TASK_FORMAT.md（自主执行原则 + 执行模型友好规范）
>
> 核心：自主分析 → 自主决策 → 直接执行 → 记录理由（不询问用户）

---

## 🎯 AI 可维护性优先（核心原则）

> **适用场景**：独立开发 + Claude Code 全程生成/维护
>
> **核心洞察**：AI 不嫌文件大，嫌文件多且分散。理解 500 行内聚代码 < 跳 5 个 60 行文件组装逻辑

### 重构判断标准

| 判断维度 | ✅ 生成任务 | ❌ 不生成任务 |
|---------|-----------|--------------|
| **职责是否单一？** | 职责混乱 → 拆分 | 职责单一 → 保持 |
| **是否会被复用？** | 会复用 → 提取组件 | 仅一处用 → 保持内聚 |
| **是否有循环依赖？** | 有依赖 → 消除 | 无依赖 → 不动 |
| **代码是否重复？** | 有重复 → 统一 | 无重复 → 不动 |
| **文件行数** | — | ❌ 不作为判断依据 |

### 禁止机械式目标

```markdown
# ❌ 错误的重构目标
| 最大 Widget 行数 | 761 → ≤200 |
| 最大 ViewModel 行数 | 333 → ≤250 |
| 最大 DAO 行数 | 412 → ≤300 |

# ✅ 正确的重构目标
| RandomResultDialog 职责混乱？ | 拆分职责，而非机械按行数拆 |
| ManagementViewModel 职责过载？ | 已用 Mixin 分离，无需再拆 |
| OptionDao 包含分组操作？ | 移到 OptionGroupDao（职责单一） |
```

### 实用判断流程

```
读取文件 → 理解职责 → 判断

├── 职责单一且内聚？
│   └── ✅ 保持原状（不管行数多少）
│
├── 职责混乱？
│   └── ✅ 按职责拆分（不是按行数切）
│
└── 有可复用的部分？
    └── ✅ 提取到共享位置
```

### 典型场景

| 场景 | 判断 | 动作 |
|------|------|------|
| 761 行的对话框，职责单一 | ✅ 内聚 | 不拆 |
| 333 行的 ViewModel，已用 Mixin 分离 | ✅ 已分离 | 不拆 |
| DAO 包含两种实体的操作 | ❌ 职责混乱 | 按实体拆分 |
| 动画效果仅在单一页面使用 | ❌ 不复用 | 不提取 |
| 工具函数在多处复制 | ❌ 重复 | 统一到 shared |

---

## 📋 执行策略

### 第一步：充分探索项目 ⭐ 关键

**规划质量决定执行效率**。在生成任务前，必须深入理解项目：

- 阅读核心文档（README、CLAUDE.md、PROJECT_STATUS.md）
- 浏览项目结构，理解模块划分和依赖关系
- 查找代码中的 TODO/FIXME 注释（真实痛点）

**扫描重构需求**（按优先级）：
1. **职责混乱**：一个类/文件处理多个不相关的职责
2. **循环依赖**：模块间互相依赖，难以理解
3. **代码重复**：相同逻辑在多处复制

**⚠️ 重要**：不要因为"文件行数多"就生成拆分任务。只有在**职责混乱**或**需要复用**时才拆分。

### 第二步：生成任务编排文件

```
项目根目录/
├── task-refactor-project                # 主任务文件
└── .refactor-tasks/                     # 重构任务细节
    ├── stage-1-module-refactor.md       # 模块重构（并行）
    ├── stage-2-integration.md           # 集成验证
    └── stage-3-documentation.md         # 文档更新
```

**主任务文件格式**：

```markdown
## STAGE ## name="module-refactor" mode="parallel" max_workers="4"
@.refactor-tasks/stage-1-module-refactor.md

## STAGE ## name="integration" mode="serial"
@.refactor-tasks/stage-2-integration.md

## STAGE ## name="documentation" mode="parallel" max_workers="2"
@.refactor-tasks/stage-3-documentation.md
```

### ⚠️ 子文件 TASK 格式（执行模型友好版）

被引用的子文件中，**每个任务必须使用增强格式**：

```markdown
# Stage 1: 模块重构

> **🏠 项目背景**：[项目类型] + [技术栈] + [当前状态]
> 本阶段重构各独立模块，可并行执行。

## TASK ##
拆分 UserService 职责

**🏠 项目背景**：
电商后台系统，NestJS + TypeORM + PostgreSQL。
UserService 当前混合了认证、个人信息、订单查询等多个职责。

**🎯 任务目标**：
将 UserService 按职责拆分为多个服务，每个服务职责单一。

**📁 核心文件**：
- `src/modules/user/user.service.ts` - [修改] 拆分职责
- `src/modules/user/user-auth.service.ts` - [新建] 认证相关方法
- `src/modules/user/user-profile.service.ts` - [新建] 个人信息相关方法
- `src/modules/user/user.controller.ts` - [修改] 更新依赖注入

**🔨 执行步骤**：
1. 阅读 `user.service.ts`，识别不同职责的方法
2. 创建 `user-auth.service.ts`，迁移认证相关方法
3. 创建 `user-profile.service.ts`，迁移个人信息方法
4. 更新 `user.controller.ts` 的依赖注入
5. 运行测试验证

**✅ 完成标志**：
- [ ] UserService 职责单一（仅保留核心用户操作）
- [ ] 无循环依赖（可用 `madge` 检查）
- [ ] `npm test -- user` 全部通过

**⚠️ 注意事项**：
- 不要修改 `src/common/` 目录
- 保持 API 接口不变
- ⚠️ 不以"行数减少"为目标，以"职责清晰"为目标

文件: src/modules/user/**/*.ts
排除: src/common/
验证: npm test -- user --silent
```

**格式要点**：
- 使用 `## TASK ##`（注意两边都有 `##`）
- **必须包含**：🎯 任务目标、📁 核心文件、✅ 完成标志
- **推荐包含**：🏠 项目背景、🔨 执行步骤、⚠️ 注意事项
- `文件:` 字段必填（用于冲突检测）
- **禁止**：以"行数 ≤ XXX"作为完成标志

### 第三步：各阶段任务设计

| 阶段 | 内容 | 执行模式 |
|------|------|---------|
| **Stage 1** 模块重构 | 各模块独立重构（每个任务自带单元测试验证） | **并行** |
| **Stage 2** 集成验证 | 全量测试 + 跨模块集成检查 | 串行 |
| **Stage 3** 文档更新 | 架构文档、功能映射、ADR | 并行 |

**设计理念**：
- ❌ 不需要单独的"基础设施准备"阶段 — Git 本身就是回滚方案
- ✅ 每个模块任务自带验证命令，边重构边测试
- ✅ 集成验证阶段统一运行全量测试，确保跨模块兼容

---

## 📏 字数约束

- **单个 TASK 描述**：20-40 行
- **每个 stage 文件**：80-150 行

---

## 🎯 重要约束

1. **职责优先于行数** - 职责单一的大文件 > 职责混乱的多个小文件
2. **内聚优先于复用** - 不复用的代码提取反而增加复杂度
3. **测试驱动** - 每阶段测试验证，不过不进下一阶段
4. **不要过度设计** - 解决现有问题，不为"可能的未来"设计
5. **Git 里程碑** - 重构前确保工作区干净，方便回滚

---

## 💎 严格禁止

**任务文件格式**：
1. **内嵌详细示例** ⛔ - 只说明任务类型和关注点
2. **硬编码具体命令** ⛔ - 让 AI 根据项目配置查找
3. **过度详细步骤** ⛔ - 描述目标和验证标准

**重构判断**：
1. **以行数为目标** ⛔ - `行数 ≤ 200` 不是重构目标
2. **机械拆分** ⛔ - 只在职责混乱时拆分，不是"文件大就拆"
3. **为复用而复用** ⛔ - 提取不复用的组件是过度设计
4. **创建过度抽象** ⛔ - 20 行代码的 Service 类没有价值

---

## 相关文档
- @templates/workflow/DAG_TASK_FORMAT.md - 详细格式规范
- @comprehensive-health-check.md - 建议先运行健康检查
- `/refactor-module` - 单模块重构
- `/refactor` - 简单重构（单文件）
