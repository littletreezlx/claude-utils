# 会话保存

## 核心目标
保存当前会话的上下文、进度和待办任务，便于脚本连续调用 `/todo-doit` 自动完成大任务。

**关键约束**：任务将由**低智能模型**（如 GLM4.7）执行，任务描述必须**完整自包含**。

## ⚠️ 关键要求（支持自动化执行）

### 1. 上下文必须完整自足（执行模型友好）

**核心问题**：执行模型智能较低，无法从简略描述"推断"上下文。

每个任务描述必须包含：
- **🏠 项目背景**：项目是什么、技术栈、当前状态
- **🎯 任务目标**：具体要达成什么（可验证）
- **📁 核心文件**：精确路径 + 操作类型
- **🔨 执行步骤**：3-5 步具体操作
- **✅ 完成标志**：客观可验证的标准

❌ 错误示例（依赖执行者理解能力）：
```
- [ ] 修复用户模块的 bug
```

✅ 正确示例（完整自包含）：
```
- [ ] 修复用户登录后 token 未正确存储的问题
  - 🏠 项目背景: 电商后台系统，React + TypeScript，使用 localStorage 存储认证信息
  - 🎯 任务目标: 修复 Safari 隐私模式下登录后刷新页面被踢出的问题
  - 📁 核心文件:
    - `src/auth/token.ts:45` - [修改] localStorage.setItem 静默失败
    - `src/auth/storage.ts` - [参考] 查看其他存储实现
  - 🔨 执行步骤:
    1. 阅读 `src/auth/token.ts` 了解当前 token 存储逻辑
    2. 添加 try-catch 包裹 localStorage.setItem
    3. 在 catch 中 fallback 到 sessionStorage
    4. 运行测试验证
  - ✅ 完成标志:
    - [ ] token.ts 中 setItem 有 try-catch
    - [ ] Safari 隐私模式下登录后刷新保持登录状态
```

### 2. 必须有"下一步行动"
- 让脚本知道该做什么
- 必须明确、可执行、包含完整上下文
- 只写一个下一步任务（最优先的那个）
- **使用增强格式**，确保执行模型能正确理解

### 3. 任务状态清晰
- 进行中 → 标记为 `[~]`
- 待办 → 标记为 `[ ]`
- 已完成 → 标记为 `[x]` + 时间戳

### 4. 完成即停止
- 所有任务完成时，下一步行动标记为 `✅ 所有任务已完成`
- 不要编造新任务

## 保存内容

### 必须包含
- **🎯 下一步行动**: 唯一的下一个任务（包含完整上下文）
- **项目背景**: 这个项目/功能的整体目标是什么（2-3 句话）
- **当前进度**: 整体完成了多少，还剩多少
- **已完成内容**: 本次会话完成了哪些工作（具体到文件 + 时间戳）
- **待办任务**: 后续要做的事（每个任务都要有背景和验证标准）
- **关键上下文**: 重要的技术决策、遇到的问题、解决思路

### 可选包含
- 相关文件引用（使用相对路径）
- 需要注意的风险点
- 待验证的假设
- 已尝试但失败的方案（避免重复踩坑）

## 输出位置
项目根目录的 `TODO.md` 文件

## 编写原则
- **自动化友好**: 格式标准化，便于脚本解析
- **下一步明确**: 让脚本无需询问即可继续
- **任务可执行**: 每个任务清晰具体，包含验收标准
- **包含必要引用**: 提供文件路径便于定位
- **完成即停止**: 任务完成时明确标记，不强行继续

## 标准输出格式（执行模型友好版）

```markdown
# TODO - [日期]

## 🏠 项目背景
> 让执行模型快速了解项目是什么

- **项目类型**: [Web 应用 / 移动端 / CLI 工具 / ...]
- **技术栈**: [React + TypeScript / Flutter / Python FastAPI / ...]
- **当前状态**: [新项目 / 已上线 / 重构中 / ...]
- **整体目标**: [2-3 句话说明要做什么]

例如：电商后台管理系统，使用 React + TypeScript + Ant Design。
当前正在实现订单导出功能，后端 API 已完成，正在实现前端交互。

## 🎯 下一步行动
> 脚本将自动执行这个任务（必须包含完整上下文，执行模型可能完全不了解项目）

- [ ] [具体任务标题]
  - **🏠 项目背景**: [如果与上面不同或需要补充]
  - **🎯 任务目标**: [具体要达成什么，必须可验证]
  - **📁 核心文件**:
    - `src/xxx/target.ts` - [修改] 添加 XXX 功能
    - `src/xxx/reference.ts` - [参考] 查看现有实现
  - **🔨 执行步骤**:
    1. [第一步：具体操作]
    2. [第二步：具体操作]
    3. [第三步：具体操作]
  - **✅ 完成标志**:
    - [ ] [客观可验证的标准 1]
    - [ ] [客观可验证的标准 2]
  - **⚠️ 注意事项**: [常见坑点，可选]

<!-- 所有任务完成时改为：
## 🎯 下一步行动
✅ 所有任务已完成
-->

## 当前进度
整体进度: 3/7 个任务已完成
当前阶段: [正在做什么功能/修复什么问题]

## 本次完成
- [x] 已完成任务1 - [2025-11-09 14:30]
  - 做了什么: 简要说明
  - 产出文件: `src/...`
- [x] 已完成任务2 - [2025-11-09 15:15]

## 待办任务

### 高优先级
- [ ] 任务1
  - 🎯 目标: 具体要做什么
  - 📁 文件: `src/...`
  - ✅ 验证: 完成标准
- [ ] 任务2

### 普通优先级
- [ ] 任务3

## 关键上下文

### 技术决策
- **决策1**: [选择了什么] - [为什么这么选]
- **决策2**: [选择了什么] - [为什么这么选]

### 遇到的问题
- **问题1**: [问题描述] - [当前状态/解决思路]

### 已尝试但失败的方案（避免重复踩坑）
- 方案A: [为什么不行]

## 相关文件
- `src/...` - 说明（核心文件，修改时要注意 xxx）
```

## 自动化执行示例

**脚本可以连续调用 `/todo-doit`：**

```bash
# 第一次调用
/todo-doit  # 读取"下一步行动"，执行任务1，完成后更新 TODO.md

# 第二次调用（自动）
/todo-doit  # 读取新的"下一步行动"，执行任务2，完成后更新 TODO.md

# 第三次调用（自动）
/todo-doit  # 读取到"✅ 所有任务已完成"，停止执行
```
