# 会话保存

## 核心目标
保存当前会话的上下文、进度和待办任务，便于脚本连续调用 `/todo-doit` 自动完成大任务。

## ⚠️ 关键要求（支持自动化执行）

### 1. 上下文必须完整自足
**最常见问题：上下文写得太简略，新会话无法理解**

每个任务描述必须包含：
- **为什么做**：业务背景、用户需求、问题根因
- **做什么**：具体的技术目标和范围
- **怎么验证**：明确的完成标准

❌ 错误示例：
```
- [ ] 修复用户模块的 bug
```

✅ 正确示例：
```
- [ ] 修复用户登录后 token 未正确存储的问题
  - 背景: 用户反馈登录成功后刷新页面会被踢出
  - 根因: `src/auth/token.ts:45` 的 localStorage.setItem 在 Safari 隐私模式下静默失败
  - 方案: 添加 try-catch + fallback 到 sessionStorage
  - 验证: 在 Safari 隐私模式下登录后刷新，应保持登录状态
```

### 2. 必须有"下一步行动"
- 让脚本知道该做什么
- 必须明确、可执行、包含验收标准
- 只写一个下一步任务（最优先的那个）

### 3. 任务状态清晰
- 进行中 → 标记为 `[~]`
- 待办 → 标记为 `[ ]`
- 已完成 → 标记为 `[x]` + 时间戳

### 4. 完成即停止
- 所有任务完成时，下一步行动标记为 `✅ 所有任务已完成`
- 不要编造新任务

## 保存内容

### 必须包含
- **🎯 下一步行动**: 唯一的下一个任务（包含完整上下文）
- **项目背景**: 这个项目/功能的整体目标是什么（2-3 句话）
- **当前进度**: 整体完成了多少，还剩多少
- **已完成内容**: 本次会话完成了哪些工作（具体到文件 + 时间戳）
- **待办任务**: 后续要做的事（每个任务都要有背景和验证标准）
- **关键上下文**: 重要的技术决策、遇到的问题、解决思路

### 可选包含
- 相关文件引用（使用相对路径）
- 需要注意的风险点
- 待验证的假设
- 已尝试但失败的方案（避免重复踩坑）

## 输出位置
项目根目录的 `TODO.md` 文件

## 编写原则
- **自动化友好**: 格式标准化，便于脚本解析
- **下一步明确**: 让脚本无需询问即可继续
- **任务可执行**: 每个任务清晰具体，包含验收标准
- **包含必要引用**: 提供文件路径便于定位
- **完成即停止**: 任务完成时明确标记，不强行继续

## 标准输出格式

```markdown
# TODO - [日期]

## 项目背景
[2-3 句话说明整体目标，让新会话快速理解我们在做什么]

例如：为电商平台实现订单导出功能。用户需要将订单数据导出为 Excel/CSV 格式，
支持按时间范围和订单状态筛选。当前后端 API 已完成，正在实现前端交互。

## 🎯 下一步行动
> 脚本将自动执行这个任务（必须包含完整上下文）

- [ ] [具体任务]
  - **背景**: 为什么要做这个
  - **目标**: 具体要实现什么
  - **方案**: 技术实现思路
  - **文件**: `src/...`
  - **验证**: 如何确认完成

<!-- 所有任务完成时改为：
## 🎯 下一步行动
✅ 所有任务已完成
-->

## 当前进度
整体进度: 3/7 个任务已完成
当前阶段: [正在做什么功能/修复什么问题]

## 本次完成
- [x] 已完成任务1 - [2025-11-09 14:30]
  - 做了什么: 简要说明
  - 产出文件: `src/...`
- [x] 已完成任务2 - [2025-11-09 15:15]

## 待办任务

### 高优先级
- [ ] 任务1
  - 背景: 为什么重要
  - 目标: 具体要做什么
  - 验证: 完成标准
- [ ] 任务2

### 普通优先级
- [ ] 任务3

## 关键上下文

### 技术决策
- **决策1**: [选择了什么] - [为什么这么选]
- **决策2**: [选择了什么] - [为什么这么选]

### 遇到的问题
- **问题1**: [问题描述] - [当前状态/解决思路]

### 已尝试但失败的方案（避免重复踩坑）
- 方案A: [为什么不行]

## 相关文件
- `src/...` - 说明（核心文件，修改时要注意 xxx）
```

## 自动化执行示例

**脚本可以连续调用 `/todo-doit`：**

```bash
# 第一次调用
/todo-doit  # 读取"下一步行动"，执行任务1，完成后更新 TODO.md

# 第二次调用（自动）
/todo-doit  # 读取新的"下一步行动"，执行任务2，完成后更新 TODO.md

# 第三次调用（自动）
/todo-doit  # 读取到"✅ 所有任务已完成"，停止执行
```
