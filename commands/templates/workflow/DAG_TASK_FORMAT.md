# DAG ä»»åŠ¡ç¼–æ’æ ¼å¼è§„èŒƒ

> ç”¨äº `/todo-huge-task` ç”Ÿæˆçš„ä»»åŠ¡æ–‡ä»¶æ ¼å¼ï¼Œæ”¯æŒ `batchcc.py` æ™ºèƒ½ä¸²è¡Œ/å¹¶è¡Œæ‰§è¡Œ

## ğŸ“‹ æ ¸å¿ƒæ¦‚å¿µ

### STAGEï¼ˆé˜¶æ®µï¼‰
**ç²—ç²’åº¦ç¼–æ’å•å…ƒ**ï¼ŒåŒ…å«ä¸€ç»„ç›¸å…³ä»»åŠ¡ï¼Œå®šä¹‰æ‰§è¡Œæ¨¡å¼ï¼ˆä¸²è¡Œ/å¹¶è¡Œï¼‰ã€‚

### TASKï¼ˆä»»åŠ¡ï¼‰
**ç»†ç²’åº¦æ‰§è¡Œå•å…ƒ**ï¼Œå…·ä½“çš„å·¥ä½œé¡¹ï¼Œå¯ä»¥å®šä¹‰ä¾èµ–å…³ç³»å’Œå¤±è´¥ç­–ç•¥ã€‚

### æ‰§è¡Œæµç¨‹
```
Stage 1 [ä¸²è¡Œ] â†’ Stage 2 [å¹¶è¡Œ] â†’ Stage 3 [ä¸²è¡Œ]
    â†“               â†“                  â†“
  Task 1          Task 2~4           Task 5~6
  Task 2          (å¹¶è¡Œæ‰§è¡Œ)         (ä¸²è¡Œæ‰§è¡Œ)
  (é¡ºåºæ‰§è¡Œ)
```

---

## ğŸ¤– è‡ªä¸»æ‰§è¡ŒåŸåˆ™

### DAG ä»»åŠ¡çš„æ ¸å¿ƒç‰¹æ€§
DAG ä»»åŠ¡ä½“ç³»è®¾è®¡ä¸º**å®Œå…¨è‡ªåŠ¨åŒ–ã€æ— äººå€¼å®ˆ**çš„æ‰§è¡Œç³»ç»Ÿã€‚

### Claude åœ¨ DAG ä»»åŠ¡ä¸­çš„è¡Œä¸ºå‡†åˆ™

#### âœ… åº”è¯¥åšçš„
1. **è‡ªä¸»åˆ†æ**ï¼šæ·±å…¥ç†è§£ä»»åŠ¡ç›®æ ‡å’Œå½“å‰é¡¹ç›®çŠ¶æ€
2. **è‡ªä¸»å†³ç­–**ï¼šåŸºäºä¼˜å…ˆçº§ã€å½±å“é¢ã€æŠ€æœ¯å¯è¡Œæ€§é€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆ
3. **ç›´æ¥æ‰§è¡Œ**ï¼šä¸è¯¢é—®ç”¨æˆ·ï¼Œç›´æ¥å®æ–½é€‰å®šçš„æ–¹æ¡ˆ
4. **è®°å½•ç†ç”±**ï¼šåœ¨æ—¥å¿—ä¸­æ¸…æ™°è¯´æ˜å†³ç­–ä¾æ®å’Œæ‰§è¡Œè·¯å¾„

#### âŒ ä¸åº”è¯¥åšçš„
1. è¯¢é—®ç”¨æˆ·"éœ€è¦æˆ‘å¸®æ‚¨...å—ï¼Ÿ"
2. åˆ—å‡ºå¤šä¸ªé€‰é¡¹è®©ç”¨æˆ·é€‰æ‹©
3. ç­‰å¾…ç”¨æˆ·ç¡®è®¤åæ‰ç»§ç»­æ‰§è¡Œ
4. åœ¨ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­è®¾è®¡äº¤äº’å¼ç¯èŠ‚

### ä»»åŠ¡ç¼–å†™è¦æ±‚

ä¸ºäº†æ”¯æŒ Claude çš„è‡ªä¸»å†³ç­–ï¼Œä»»åŠ¡æè¿°åº”è¯¥ï¼š

1. **ç›®æ ‡æ˜ç¡®**ï¼šæ¸…æ™°è¡¨è¾¾è¦è¾¾æˆçš„ç›®æ ‡
2. **è¾¹ç•Œæ¸…æ™°**ï¼šæ˜ç¡®ä»»åŠ¡çš„èŒƒå›´å’Œçº¦æŸæ¡ä»¶
3. **ä¸Šä¸‹æ–‡å……åˆ†**ï¼šæä¾›è¶³å¤Ÿçš„èƒŒæ™¯ä¿¡æ¯
4. **æ ‡å‡†å¯éªŒè¯**ï¼šæ˜ç¡®çš„å®Œæˆæ ‡å¿—å’ŒéªŒè¯æ–¹å¼

**ç¤ºä¾‹å¯¹æ¯”**ï¼š

âŒ **ä¸æ¸…æ™°çš„ä»»åŠ¡**ï¼ˆä¼šå¯¼è‡´ Claude è¯¢é—®ç”¨æˆ·ï¼‰ï¼š
```markdown
## TASK ##
ä¼˜åŒ–é”™è¯¯å¤„ç†

æ–‡ä»¶: src/**/*.ts
```

âœ… **æ¸…æ™°çš„ä»»åŠ¡**ï¼ˆClaude å¯ä»¥è‡ªä¸»å†³ç­–å¹¶æ‰§è¡Œï¼‰ï¼š
```markdown
## TASK ##
ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶

**ğŸ“– èƒŒæ™¯**ï¼š
å½“å‰å„æ¨¡å—æœ‰ç‹¬ç«‹çš„é”™è¯¯å¤„ç†å™¨ï¼Œå¯¼è‡´ï¼š
- é”™è¯¯æ ¼å¼ä¸ä¸€è‡´
- æ—¥å¿—è®°å½•é‡å¤
- éš¾ä»¥ç»Ÿä¸€ç›‘æ§

**ğŸ”¨ è¦åšä»€ä¹ˆ**ï¼š
1. åˆ›å»ºç»Ÿä¸€çš„ ErrorHandler ç±»
2. å®ç°æ ‡å‡†çš„é”™è¯¯å“åº”æ ¼å¼
3. é›†æˆåˆ°å„æ¨¡å—çš„ API å±‚
4. ç»Ÿä¸€é”™è¯¯æ—¥å¿—è®°å½•

**âœ… å®Œæˆæ ‡å¿—**ï¼š
- æ‰€æœ‰ API é”™è¯¯è¿”å›ç»Ÿä¸€æ ¼å¼
- é”™è¯¯æ—¥å¿—åŒ…å« trace_id
- å•å…ƒæµ‹è¯•è¦†ç›–ä¸»è¦é”™è¯¯åœºæ™¯

æ–‡ä»¶: src/common/error-handler.ts
æ–‡ä»¶: src/modules/*/controller.ts
éªŒè¯: npm test -- error-handler && npm run lint
```

### å†³ç­–å¤±è´¥å¤„ç†

**åªåœ¨çœŸæ­£æ— æ³•å†³ç­–æ—¶æ‰æ ‡è®°ä»»åŠ¡å¤±è´¥**ã€‚

å¦‚æœé‡åˆ°éœ€è¦**ä¸šåŠ¡åˆ¤æ–­**çš„æƒ…å†µï¼ˆå¦‚æŠ€æœ¯é€‰å‹ã€æ¶æ„æ–¹æ¡ˆï¼‰ï¼Œåº”è¯¥ï¼š

1. æ ‡è®°ä»»åŠ¡çŠ¶æ€ä¸º `failed`
2. åœ¨é”™è¯¯ä¿¡æ¯ä¸­æ¸…æ™°è¯´æ˜æ— æ³•å†³ç­–çš„åŸå› 
3. åˆ—å‡ºå¯é€‰æ–¹æ¡ˆå’Œå„è‡ªçš„ä¼˜åŠ£åˆ†æ
4. å»ºè®®ç”¨æˆ·åœ¨ä»»åŠ¡æè¿°ä¸­æ˜ç¡®é€‰æ‹©æˆ–è¡¥å……ä¿¡æ¯

**ç¤ºä¾‹**ï¼š
```markdown
âŒ Task å¤±è´¥

åŸå› ï¼šæ— æ³•å†³ç­– ORM æ¡†æ¶é€‰æ‹©
- é€‰é¡¹ Aï¼šTypeORMï¼ˆæˆç†Ÿç¨³å®šï¼Œä½†æ€§èƒ½ä¸€èˆ¬ï¼‰
- é€‰é¡¹ Bï¼šPrismaï¼ˆç±»å‹å®‰å…¨ï¼Œä½†è¿ç§»å¤æ‚ï¼‰
- é€‰é¡¹ Cï¼šMikroORMï¼ˆçµæ´»å¼ºå¤§ï¼Œä½†ç”Ÿæ€è¾ƒå°ï¼‰

è¿™éœ€è¦æƒè¡¡ï¼š
- å›¢é˜ŸæŠ€æœ¯æ ˆç†Ÿæ‚‰åº¦
- æ€§èƒ½è¦æ±‚
- æœªæ¥æ‰©å±•æ€§

å»ºè®®ï¼šåœ¨ä»»åŠ¡æè¿°ä¸­æ˜ç¡® ORM é€‰æ‹©ï¼Œæˆ–åœ¨é¡¹ç›®æ–‡æ¡£ä¸­è¯´æ˜æŠ€æœ¯æ ˆæ ‡å‡†
```

---

## ğŸ¯ STAGE è¯­æ³•

### åŸºç¡€æ ¼å¼
```markdown
## STAGE ## name="é˜¶æ®µåç§°" mode="serial|parallel" max_workers="4" depends_on="stage:1,task:init"
```

### å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|------|
| `name` | string | âœ… | é˜¶æ®µåç§°ï¼ˆç”¨äºæ—¥å¿—å’Œä¾èµ–å¼•ç”¨ï¼‰ | `"åˆå§‹åŒ–æ•°æ®åº“"` |
| `mode` | enum | âœ… | æ‰§è¡Œæ¨¡å¼ï¼š`serial` æˆ– `parallel` | `"parallel"` |
| `max_workers` | int | âŒ | æœ€å¤§å¹¶å‘æ•°ï¼ˆä»… parallel æ¨¡å¼ï¼‰ | `4` |
| `depends_on` | string | âŒ | ä¾èµ–çš„é˜¶æ®µæˆ–ä»»åŠ¡ï¼ˆé€—å·åˆ†éš”ï¼‰ | `"stage:1,task:init"` |

### æ‰§è¡Œæ¨¡å¼è¯¦è§£

#### `mode="serial"` - ä¸²è¡Œæ¨¡å¼
- **ç”¨é€”**ï¼šæœ‰ä¸¥æ ¼é¡ºåºä¾èµ–çš„ä»»åŠ¡ï¼ˆæ•°æ®åº“ schemaã€é…ç½®åˆå§‹åŒ–ï¼‰
- **ç‰¹ç‚¹**ï¼šé˜¶æ®µå†…ä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œï¼Œå‰ä¸€ä¸ªå¤±è´¥åˆ™åœæ­¢
- **ç¤ºä¾‹**ï¼š
  ```markdown
  ## STAGE ## name="æ•°æ®åº“åˆå§‹åŒ–" mode="serial"

  ## TASK ##
  åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„

  ## TASK ##
  åˆå§‹åŒ–åŸºç¡€æ•°æ®ï¼ˆä¾èµ–è¡¨ç»“æ„å·²åˆ›å»ºï¼‰
  ```

#### `mode="parallel"` - å¹¶è¡Œæ¨¡å¼
- **ç”¨é€”**ï¼šç‹¬ç«‹çš„åŠŸèƒ½æ¨¡å—ã€æ— ä¾èµ–çš„ä»»åŠ¡
- **ç‰¹ç‚¹**ï¼šé˜¶æ®µå†…ä»»åŠ¡å¹¶å‘æ‰§è¡Œï¼ˆå— `max_workers` é™åˆ¶ï¼‰
- **å†²çªæ£€æµ‹**ï¼šè‡ªåŠ¨åˆ†ææ–‡ä»¶èŒƒå›´ï¼Œæœ‰å†²çªçš„ä»»åŠ¡ä¼šè‡ªåŠ¨ä¸²è¡Œ
- **ç¤ºä¾‹**ï¼š
  ```markdown
  ## STAGE ## name="å®ç°ä¸šåŠ¡æ¨¡å—" mode="parallel" max_workers="4"

  ## TASK ##
  å®ç°ç”¨æˆ·æ¨¡å—
  æ–‡ä»¶: src/modules/user/**/*.ts

  ## TASK ##
  å®ç°è®¢å•æ¨¡å—
  æ–‡ä»¶: src/modules/order/**/*.ts
  ```

### ä¾èµ–å…³ç³»è¯­æ³•

#### ä¾èµ–é˜¶æ®µ
```markdown
depends_on="stage:1"           # ä¾èµ–ç¬¬ 1 ä¸ªé˜¶æ®µ
depends_on="stage:1,stage:2"   # ä¾èµ–ç¬¬ 1 å’Œç¬¬ 2 é˜¶æ®µ
```

#### ä¾èµ–ä»»åŠ¡
```markdown
depends_on="task:init"         # ä¾èµ– ID ä¸º "init" çš„ä»»åŠ¡
depends_on="task:user,task:order"  # ä¾èµ–å¤šä¸ªä»»åŠ¡
```

#### æ··åˆä¾èµ–
```markdown
depends_on="stage:1,task:config"   # æ—¢ä¾èµ–é˜¶æ®µåˆä¾èµ–ç‰¹å®šä»»åŠ¡
```

---

## ğŸ”§ TASK è¯­æ³•

### åŸºç¡€æ ¼å¼
```markdown
## TASK ## id="ä»»åŠ¡ID" depends_on="task1,task2" on_failure="stop" retry="2"

ä»»åŠ¡æè¿°ï¼ˆå¤šè¡Œæ”¯æŒï¼‰

æ–‡ä»¶: src/path/to/files/**/*.ts
æ’é™¤: src/common/types.ts
éªŒè¯: npm test -- module-name
```

### å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|------|------|--------|
| `id` | string | âŒ | ä»»åŠ¡å”¯ä¸€æ ‡è¯†ï¼ˆç”¨äºä¾èµ–å¼•ç”¨ï¼‰ | è‡ªåŠ¨ç”Ÿæˆ |
| `depends_on` | string | âŒ | ä¾èµ–çš„ä»»åŠ¡ IDï¼ˆé€—å·åˆ†éš”ï¼‰ | æ—  |
| `on_failure` | enum | âŒ | å¤±è´¥ç­–ç•¥ï¼š`stop`/`continue`/`retry` | `stop` |
| `retry` | int | âŒ | é‡è¯•æ¬¡æ•°ï¼ˆ`on_failure="retry"` æ—¶æœ‰æ•ˆï¼‰ | `0` |

### ä»»åŠ¡å†…å®¹å­—æ®µ

#### å¿…å¡«å­—æ®µ

**ä»»åŠ¡æè¿°**ï¼ˆç¬¬ä¸€è¡Œéç©ºå†…å®¹ï¼‰ï¼š
```markdown
## TASK ##
å®ç°ç”¨æˆ·ç®¡ç† APIï¼ˆCRUD + æƒé™éªŒè¯ï¼‰
```

#### å¯é€‰å­—æ®µ

**æ–‡ä»¶èŒƒå›´**ï¼ˆç”¨äºå†²çªæ£€æµ‹ï¼‰ï¼š
```markdown
æ–‡ä»¶: src/modules/user/**/*.ts
æ–‡ä»¶: src/api/user.controller.ts, src/services/user.service.ts
```

**æ’é™¤æ–‡ä»¶**ï¼ˆé¿å…è¯¯åˆ¤å†²çªï¼‰ï¼š
```markdown
æ’é™¤: src/common/, tests/
æ’é™¤: src/types.ts
```

**éªŒè¯å‘½ä»¤**ï¼ˆä»»åŠ¡å®Œæˆåæ‰§è¡Œï¼‰ï¼š
```markdown
éªŒè¯: npm test -- user
éªŒè¯: npm run lint && npm test
```

### å¤±è´¥ç­–ç•¥è¯¦è§£

#### `on_failure="stop"` - ç«‹å³åœæ­¢ï¼ˆé»˜è®¤ï¼‰
- **ç”¨é€”**ï¼šå…³é”®ä»»åŠ¡ï¼Œå¤±è´¥åæ— æ³•ç»§ç»­
- **è¡Œä¸º**ï¼šä»»åŠ¡å¤±è´¥ç«‹å³åœæ­¢æ•´ä¸ªæµç¨‹
- **ç¤ºä¾‹**ï¼š
  ```markdown
  ## TASK ## on_failure="stop"
  åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„
  ```

#### `on_failure="continue"` - ç»§ç»­æ‰§è¡Œ
- **ç”¨é€”**ï¼šéå…³é”®ä»»åŠ¡ï¼Œå¤±è´¥ä¸å½±å“å…¶ä»–ä»»åŠ¡
- **è¡Œä¸º**ï¼šä»»åŠ¡å¤±è´¥åç»§ç»­æ‰§è¡Œåç»­ä»»åŠ¡ï¼Œæœ€åæ±‡æ€»å¤±è´¥æ¸…å•
- **ç¤ºä¾‹**ï¼š
  ```markdown
  ## TASK ## on_failure="continue"
  ç”Ÿæˆ API æ–‡æ¡£ï¼ˆå¤±è´¥ä¸å½±å“åŠŸèƒ½ï¼‰
  ```

#### `on_failure="retry"` - è‡ªåŠ¨é‡è¯•
- **ç”¨é€”**ï¼šç½‘ç»œä¸ç¨³å®šã€å¶å‘æ€§å¤±è´¥çš„ä»»åŠ¡
- **è¡Œä¸º**ï¼šå¤±è´¥åè‡ªåŠ¨é‡è¯•æŒ‡å®šæ¬¡æ•°ï¼Œå…¨éƒ¨å¤±è´¥åæŒ‰ `stop` å¤„ç†
- **ç¤ºä¾‹**ï¼š
  ```markdown
  ## TASK ## on_failure="retry" retry="3"
  è¿è¡Œ E2E æµ‹è¯•ï¼ˆç½‘ç»œè¯·æ±‚å¯èƒ½è¶…æ—¶ï¼‰
  ```

---

## ğŸ“¦ æ–‡ä»¶èŒƒå›´è§„åˆ™

### ä¸ºä»€ä¹ˆéœ€è¦æ–‡ä»¶èŒƒå›´ï¼Ÿ
- **å†²çªæ£€æµ‹**ï¼šè‡ªåŠ¨è¯†åˆ«ä¼šä¿®æ”¹ç›¸åŒæ–‡ä»¶çš„ä»»åŠ¡
- **æ™ºèƒ½è°ƒåº¦**ï¼šæ— å†²çªä»»åŠ¡å¹¶è¡Œï¼Œæœ‰å†²çªä»»åŠ¡ä¸²è¡Œ
- **å¯è§†åŒ–**ï¼šæ¸…æ™°å±•ç¤ºä»»åŠ¡å½±å“èŒƒå›´

### æ–‡ä»¶èŒƒå›´è¯­æ³•

#### Glob æ¨¡å¼ï¼ˆæ¨èï¼‰
```markdown
æ–‡ä»¶: src/modules/user/**/*.ts          # user æ¨¡å—æ‰€æœ‰ ts æ–‡ä»¶
æ–‡ä»¶: src/api/**/*.controller.ts       # æ‰€æœ‰ controller æ–‡ä»¶
æ–‡ä»¶: tests/integration/*.test.ts      # æ‰€æœ‰é›†æˆæµ‹è¯•
```

#### ç²¾ç¡®è·¯å¾„
```markdown
æ–‡ä»¶: src/config.ts, src/app.ts        # ç‰¹å®šæ–‡ä»¶ï¼ˆé€—å·åˆ†éš”ï¼‰
```

#### å¤šè¡Œå®šä¹‰
```markdown
æ–‡ä»¶: src/modules/user/user.controller.ts
æ–‡ä»¶: src/modules/user/user.service.ts
æ–‡ä»¶: src/modules/user/user.model.ts
```

### æ’é™¤è§„åˆ™

#### æ’é™¤ç‰¹å®šæ–‡ä»¶
```markdown
æ’é™¤: src/common/types.ts               # æ’é™¤å…±äº«ç±»å‹æ–‡ä»¶
```

#### æ’é™¤ç›®å½•
```markdown
æ’é™¤: src/common/, tests/               # æ’é™¤æ•´ä¸ªç›®å½•ï¼ˆæ³¨æ„å°¾éƒ¨æ–œæ ï¼‰
```

#### æ’é™¤æ¨¡å¼
```markdown
æ’é™¤: **/*.test.ts, **/*.spec.ts        # æ’é™¤æ‰€æœ‰æµ‹è¯•æ–‡ä»¶
```

### å†²çªæ£€æµ‹é€»è¾‘

**ç¤ºä¾‹ 1ï¼šæ— å†²çªï¼ˆå¯å¹¶è¡Œï¼‰**
```markdown
## TASK ## id="user"
æ–‡ä»¶: src/modules/user/**/*.ts
æ’é™¤: src/common/

## TASK ## id="order"
æ–‡ä»¶: src/modules/order/**/*.ts
æ’é™¤: src/common/

# ç»“æœï¼šæ— æ–‡ä»¶é‡å  â†’ å¯ä»¥å¹¶è¡Œæ‰§è¡Œ
```

**ç¤ºä¾‹ 2ï¼šæœ‰å†²çªï¼ˆè‡ªåŠ¨ä¸²è¡Œï¼‰**
```markdown
## TASK ## id="user-api"
æ–‡ä»¶: src/modules/user/**/*.ts
æ–‡ä»¶: src/common/types.ts               # ä¿®æ”¹å…±äº«ç±»å‹

## TASK ## id="order-api"
æ–‡ä»¶: src/modules/order/**/*.ts
æ–‡ä»¶: src/common/types.ts               # ä¹Ÿä¿®æ”¹å…±äº«ç±»å‹

# ç»“æœï¼štypes.ts å†²çª â†’ è‡ªåŠ¨ä¸²è¡Œæ‰§è¡Œ
```

**ç¤ºä¾‹ 3ï¼šä½¿ç”¨æ’é™¤é¿å…è¯¯åˆ¤**
```markdown
## TASK ## id="user-api"
æ–‡ä»¶: src/modules/user/**/*.ts
æ’é™¤: src/modules/user/*.test.ts        # ä¸ä¿®æ”¹æµ‹è¯•æ–‡ä»¶

## TASK ## id="user-test"
æ–‡ä»¶: src/modules/user/*.test.ts        # åªä¿®æ”¹æµ‹è¯•æ–‡ä»¶

# ç»“æœï¼šæ–‡ä»¶èŒƒå›´åˆ†ç¦» â†’ å¯ä»¥å¹¶è¡Œæ‰§è¡Œ
```

---

## ğŸ¯ å®Œæ•´ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šç”µå•†ç³»ç»Ÿå®ç°

```markdown
## STAGE ## name="åˆå§‹åŒ–æ•°æ®åº“" mode="serial"
# å¿…é¡»ä¸²è¡Œï¼šæ•°æ®åº“ schema æœ‰ä¾èµ–å…³ç³»

## TASK ## id="schema" on_failure="stop"
åˆ›å»ºæ•°æ®åº“è¡¨ç»“æ„ï¼ˆç”¨æˆ·ã€è®¢å•ã€æ”¯ä»˜ï¼‰
æ–‡ä»¶: migrations/001_create_tables.sql
éªŒè¯: npm run migrate:check

## TASK ## id="seed" depends_on="schema" on_failure="stop"
åˆå§‹åŒ–åŸºç¡€æ•°æ®ï¼ˆè§’è‰²ã€æƒé™ã€é…ç½®ï¼‰
æ–‡ä»¶: migrations/002_seed_data.sql
éªŒè¯: npm run seed:verify

## STAGE ## name="å®ç°ä¸šåŠ¡æ¨¡å—" mode="parallel" max_workers="4" depends_on="stage:1"
# å¯ä»¥å¹¶è¡Œï¼šå„æ¨¡å—ç‹¬ç«‹å¼€å‘

## TASK ## id="user-api" on_failure="continue"
å®ç°ç”¨æˆ·ç®¡ç† APIï¼ˆæ³¨å†Œã€ç™»å½•ã€æƒé™éªŒè¯ã€ä¸ªäººä¿¡æ¯ç®¡ç†ï¼‰
æ–‡ä»¶: src/modules/user/**/*.ts
æ’é™¤: src/modules/user/**/*.test.ts
éªŒè¯: npm test -- user.service.test.ts

## TASK ## id="order-api" on_failure="continue"
å®ç°è®¢å•ç®¡ç† APIï¼ˆåˆ›å»ºè®¢å•ã€æŸ¥è¯¢è®¢å•ã€çŠ¶æ€æµè½¬ã€å–æ¶ˆè®¢å•ï¼‰
æ–‡ä»¶: src/modules/order/**/*.ts
æ’é™¤: src/modules/order/**/*.test.ts
éªŒè¯: npm test -- order.service.test.ts

## TASK ## id="payment-api" on_failure="continue"
å®ç°æ”¯ä»˜é›†æˆï¼ˆæ”¯ä»˜å®ã€å¾®ä¿¡æ”¯ä»˜ã€å›è°ƒå¤„ç†ï¼‰
æ–‡ä»¶: src/modules/payment/**/*.ts
æ’é™¤: src/modules/payment/**/*.test.ts
éªŒè¯: npm test -- payment.service.test.ts

## TASK ## id="product-api" on_failure="continue"
å®ç°å•†å“ç®¡ç† APIï¼ˆå•†å“åˆ—è¡¨ã€è¯¦æƒ…ã€åº“å­˜ç®¡ç†ï¼‰
æ–‡ä»¶: src/modules/product/**/*.ts
æ’é™¤: src/modules/product/**/*.test.ts
éªŒè¯: npm test -- product.service.test.ts

## STAGE ## name="å‰ç«¯é¡µé¢å¼€å‘" mode="parallel" max_workers="3" depends_on="stage:2"
# å¯ä»¥å¹¶è¡Œï¼šå‰ç«¯é¡µé¢ç›¸å¯¹ç‹¬ç«‹ï¼ˆå¯ä½¿ç”¨ mock æ•°æ®ï¼‰

## TASK ## id="user-ui" on_failure="continue"
å®ç°ç”¨æˆ·ç›¸å…³é¡µé¢ï¼ˆç™»å½•ã€æ³¨å†Œã€ä¸ªäººä¸­å¿ƒï¼‰
æ–‡ä»¶: src/pages/user/**/*.tsx
æ–‡ä»¶: src/components/user/**/*.tsx
æ’é™¤: src/pages/**/*.test.tsx
éªŒè¯: npm run lint:ui

## TASK ## id="order-ui" on_failure="continue"
å®ç°è®¢å•ç›¸å…³é¡µé¢ï¼ˆè®¢å•åˆ—è¡¨ã€è®¢å•è¯¦æƒ…ã€åˆ›å»ºè®¢å•ï¼‰
æ–‡ä»¶: src/pages/order/**/*.tsx
æ–‡ä»¶: src/components/order/**/*.tsx
æ’é™¤: src/pages/**/*.test.tsx
éªŒè¯: npm run lint:ui

## TASK ## id="product-ui" on_failure="continue"
å®ç°å•†å“ç›¸å…³é¡µé¢ï¼ˆå•†å“åˆ—è¡¨ã€å•†å“è¯¦æƒ…ã€è´­ç‰©è½¦ï¼‰
æ–‡ä»¶: src/pages/product/**/*.tsx
æ–‡ä»¶: src/components/product/**/*.tsx
æ’é™¤: src/pages/**/*.test.tsx
éªŒè¯: npm run lint:ui

## STAGE ## name="é›†æˆæµ‹è¯•" mode="serial" depends_on="stage:2,stage:3"
# å¿…é¡»ä¸²è¡Œï¼šæµ‹è¯•æœ‰ä¾èµ–å…³ç³»

## TASK ## id="integration-user-order" depends_on="user-api,order-api" on_failure="retry" retry="2"
ç¼–å†™ç”¨æˆ·-è®¢å•é›†æˆæµ‹è¯•ï¼ˆç”¨æˆ·ä¸‹å•æµç¨‹ï¼‰
æ–‡ä»¶: tests/integration/user-order.test.ts
éªŒè¯: npm run test:integration -- user-order

## TASK ## id="integration-order-payment" depends_on="order-api,payment-api" on_failure="retry" retry="2"
ç¼–å†™è®¢å•-æ”¯ä»˜é›†æˆæµ‹è¯•ï¼ˆå®Œæ•´æ”¯ä»˜æµç¨‹ï¼‰
æ–‡ä»¶: tests/integration/order-payment.test.ts
éªŒè¯: npm run test:integration -- order-payment

## STAGE ## name="ç«¯åˆ°ç«¯æµ‹è¯•" mode="parallel" max_workers="2" depends_on="stage:4"
# å¯ä»¥å¹¶è¡Œï¼šE2E æµ‹è¯•åœºæ™¯ç‹¬ç«‹

## TASK ## id="e2e-auth" on_failure="retry" retry="3"
E2E æµ‹è¯•ï¼šç”¨æˆ·æ³¨å†Œç™»å½•æµç¨‹
éªŒè¯: npm run test:e2e -- auth.spec.ts

## TASK ## id="e2e-checkout" on_failure="retry" retry="3"
E2E æµ‹è¯•ï¼šå®Œæ•´è´­ç‰©æµç¨‹ï¼ˆæµè§ˆ-ä¸‹å•-æ”¯ä»˜-å®Œæˆï¼‰
éªŒè¯: npm run test:e2e -- checkout.spec.ts

## TASK ## id="e2e-order-mgmt" on_failure="retry" retry="3"
E2E æµ‹è¯•ï¼šè®¢å•ç®¡ç†æµç¨‹ï¼ˆæŸ¥çœ‹-å–æ¶ˆ-é€€æ¬¾ï¼‰
éªŒè¯: npm run test:e2e -- order-management.spec.ts
```

### ç¤ºä¾‹ 2ï¼šæ•°æ®è¿ç§»é¡¹ç›®

```markdown
## STAGE ## name="æ•°æ®å¤‡ä»½" mode="serial"

## TASK ## on_failure="stop"
å¤‡ä»½ç”Ÿäº§æ•°æ®åº“
éªŒè¯: ls -lh backup/prod-*.sql

## STAGE ## name="è¿ç§»è„šæœ¬å¼€å‘" mode="parallel" max_workers="3" depends_on="stage:1"

## TASK ## id="user-migration"
ç¼–å†™ç”¨æˆ·æ•°æ®è¿ç§»è„šæœ¬
æ–‡ä»¶: migrations/users/**/*.ts
éªŒè¯: npm test -- migrations/users

## TASK ## id="order-migration"
ç¼–å†™è®¢å•æ•°æ®è¿ç§»è„šæœ¬
æ–‡ä»¶: migrations/orders/**/*.ts
éªŒè¯: npm test -- migrations/orders

## TASK ## id="product-migration"
ç¼–å†™å•†å“æ•°æ®è¿ç§»è„šæœ¬
æ–‡ä»¶: migrations/products/**/*.ts
éªŒè¯: npm test -- migrations/products

## STAGE ## name="æµ‹è¯•ç¯å¢ƒè¿ç§»" mode="serial" depends_on="stage:2"

## TASK ## on_failure="stop"
åœ¨æµ‹è¯•ç¯å¢ƒæ‰§è¡Œè¿ç§»
éªŒè¯: npm run migrate:test && npm run verify:test

## STAGE ## name="ç”Ÿäº§ç¯å¢ƒè¿ç§»" mode="serial" depends_on="stage:3"

## TASK ## on_failure="stop"
åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œè¿ç§»ï¼ˆéœ€äººå·¥ç¡®è®¤ï¼‰
éªŒè¯: npm run migrate:prod
```

---

## ğŸš€ æ‰§è¡Œæ–¹å¼

### ç”Ÿæˆä»»åŠ¡æ–‡ä»¶
```bash
# ä½¿ç”¨ /todo-huge-task å‘½ä»¤ç”Ÿæˆ
/todo-huge-task "å®ç°ç”µå•†ç”¨æˆ·å’Œè®¢å•ç³»ç»Ÿ"

# è¾“å‡ºæ–‡ä»¶ï¼štodo-taskï¼ˆç¬¦åˆ DAG æ ¼å¼ï¼‰
```

### æ‰§è¡Œä»»åŠ¡
```bash
# 1. é¢„è§ˆæ‰§è¡Œè®¡åˆ’ï¼ˆä¸å®é™…æ‰§è¡Œï¼‰
python batchcc.py todo-task --dry-run

# 2. å®Œæ•´æ‰§è¡Œ
python batchcc.py todo-task

# 3. ä»ç‰¹å®šé˜¶æ®µå¼€å§‹æ‰§è¡Œ
python batchcc.py todo-task --from-stage 3

# 4. åªæ‰§è¡Œç‰¹å®šé˜¶æ®µ
python batchcc.py todo-task --stage 2
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### æ–‡ä»¶èŒƒå›´æ ‡æ³¨
- âœ… **å»ºè®®**ï¼šå°½å¯èƒ½è¯¦ç»†æ ‡æ³¨æ–‡ä»¶èŒƒå›´ï¼Œå¸®åŠ©å†²çªæ£€æµ‹
- âš ï¸ **è­¦å‘Š**ï¼šä¸æ ‡æ³¨æ–‡ä»¶èŒƒå›´æ—¶ï¼Œbatchcc æ— æ³•è‡ªåŠ¨æ£€æµ‹å†²çª
- ğŸ’¡ **æŠ€å·§**ï¼šä½¿ç”¨ `æ’é™¤:` é¿å…å…±äº«æ–‡ä»¶å¯¼è‡´çš„è¯¯åˆ¤

### ä¾èµ–å…³ç³»
- âœ… **æ¸…æ™°ä¾èµ–**ï¼šæ˜ç¡®æ ‡æ³¨ `depends_on`ï¼Œé¿å…æ‰§è¡Œé¡ºåºé”™è¯¯
- âš ï¸ **å¾ªç¯ä¾èµ–**ï¼šbatchcc ä¼šæ£€æµ‹å¹¶æŠ¥é”™ï¼Œéœ€æ‰‹åŠ¨ä¿®å¤
- ğŸ’¡ **é˜¶æ®µä¾èµ–ä¼˜å…ˆ**ï¼šä¼˜å…ˆä½¿ç”¨ `depends_on="stage:N"` è€Œéå…·ä½“ä»»åŠ¡

### å¤±è´¥ç­–ç•¥
- âœ… **å…³é”®ä»»åŠ¡ç”¨ stop**ï¼šæ•°æ®åº“ã€é…ç½®ç­‰åŸºç¡€ä»»åŠ¡
- âœ… **ç‹¬ç«‹ä»»åŠ¡ç”¨ continue**ï¼šæ–‡æ¡£ç”Ÿæˆã€éå…³é”®åŠŸèƒ½
- âœ… **ç½‘ç»œä»»åŠ¡ç”¨ retry**ï¼šE2E æµ‹è¯•ã€API è°ƒç”¨

### å¹¶è¡Œåº¦æ§åˆ¶
- âš ï¸ **ä¸è¦è¿‡å¤§**ï¼š`max_workers` ä¸å»ºè®®è¶…è¿‡ CPU æ ¸å¿ƒæ•°
- ğŸ’¡ **æŒ‰åœºæ™¯è°ƒæ•´**ï¼šCPU å¯†é›†å‹ä»»åŠ¡ï¼ˆç¼–è¯‘ï¼‰ç”¨å°å€¼ï¼ŒIO å¯†é›†å‹ï¼ˆç½‘ç»œï¼‰å¯ç”¨å¤§å€¼
- âš ï¸ **è€ƒè™‘èµ„æºé™åˆ¶**ï¼šæ•°æ®åº“è¿æ¥æ•°ã€API é™æµç­‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [todo-huge-task å‘½ä»¤æ–‡æ¡£](../commands/todo-huge-task.md)
- [batchcc.py ä½¿ç”¨æŒ‡å—](../../python_test/projects/claude-code/README.md)
- [ä»»åŠ¡ç¼–æ’æœ€ä½³å®è·µ](./DAG_BEST_PRACTICES.md)

---

**ç‰ˆæœ¬**: v1.0
**æ›´æ–°æ—¥æœŸ**: 2025-11-10
**ç»´æŠ¤è€…**: Claude Code
