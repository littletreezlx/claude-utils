# android-base 合并前检查

> 检查 android-base 更新对 POS/KDS/TV 三个项目的影响，评估哪些项目可以安全合并

## 核心场景

在某个项目（如 TV）开发时更新了 android-base，需要评估：
- 当前项目的兼容性
- **其他项目（POS、KDS）能否也同步更新**

## 使用方式

```bash
# 在任意项目目录下执行，会检查所有三个项目
cd ~/AndroidStudioProjects/Work_Projects/android-kds
/work-android-base-pre-merge

# 或在 Work_Projects 根目录执行
cd ~/AndroidStudioProjects/Work_Projects
/work-android-base-pre-merge
```

## 执行流程

### 1. 确定基准版本

识别当前工作目录所属项目，获取其 android-base 版本作为目标版本。

### 2. 收集三个项目的版本状态

| 项目 | 路径 | 当前版本 |
|------|------|---------|
| POS | `android-pos/packages/pos/android/` | ? |
| KDS | `android-kds/` | ? |
| TV | `smart-screen/` | ? |

### 3. 分析目标版本的变更

#### 3.1 API 层面变更
- `@Deprecated` 注解标记的 API
- 方法签名变更（参数、返回值）
- 类/接口删除或重命名
- 访问权限收紧（public → internal/private）

#### 3.2 ⚠️ 行为变更检测（关键！）

**这是最容易遗漏的问题**：方法签名没变，但内部逻辑变了。

必须对比新旧版本的核心类实现：
- 内部状态管理是否变化
- 方法的副作用是否变化
- 回调时机是否变化
- 并发/串行行为是否变化

**检查方法**：
```bash
# 对比核心类的新旧实现
git diff <旧版本>..<新版本> -- <核心文件>
```

重点关注 commit message 中的关键词：
- `refactor` + 核心模块名 → **行为可能变化**
- `移除`、`上移`、`重构` → **内部逻辑变更**
- `串行`、`并发`、`异步` → **调用模式可能受影响**

### 4. 逐项目影响评估

**对每个版本落后的项目**都执行：

#### 4.1 API 层级检查（关键！）

对于 android-base 中有重构的模块，检查项目使用的是哪个抽象层级的 API。

**⚠️ 必须遵循的检查链条：**

1. **识别重构模块**：从 git diff 中找出有重大变更的模块
2. **检查项目使用哪个 API**：高层接口？还是低层实现类？
3. **如果用的是低层 API，必须对比其新旧实现**
   ```bash
   git diff <旧版本>..<新版本> -- <该类文件>
   ```
4. **评估影响**：内部行为变了吗？项目的调用方式会受影响吗？

**常见漏检场景**：
- ❌ 发现项目没用高层 API，就跳过该模块 → 错！要查它用了什么
- ❌ 发现项目用了低层 API，签名没变就判定兼容 → 错！要对比实现

**绝对不能因为"签名未变"就判定为"向后兼容"！**

#### 4.2 行为变更深入分析（关键！）

**当识别到某个 API 有行为变更时，不能止步于"可能兼容，需测试验证"，必须深入分析：**

1. **搜索所有调用点**：找出项目中对该 API 的所有调用
2. **分析每个调用的上下文**：
   - 调用场景是什么？（单次调用 vs 批量调用）
   - 调用结果如何被使用？
   - 是否依赖旧的内部行为？
3. **给出明确结论**：兼容 / 不兼容 / 需验证，并说明理由

#### 4.3 搜索引用
- import 语句
- 方法调用
- 类继承/接口实现
- Hilt 依赖注入配置

### 5. 生成综合报告

输出所有项目的兼容性评估和合并建议。

## 输出格式

报告保存到 `docs/android-base-merge/YYYY-MM-DD.md`

```markdown
# android-base 合并检查报告

**检查时间**: YYYY-MM-DD
**目标版本**: xxxxxxx
**变更摘要**: [主要变更描述]

## 三项目兼容性总览

| 项目 | 当前版本 | 兼容性 | 需迁移 | 建议 |
|------|---------|--------|--------|------|
| ... | ... | ... | ... | ... |

## 变更分析

### API 变更
| 类型 | 变更 | 影响 |
|------|------|------|
| 废弃 | ... | ... |
| 签名变更 | ... | ... |

### ⚠️ 行为变更（重点关注）
| 类/方法 | 旧行为 | 新行为 | 影响 |
|---------|--------|--------|------|
| ... | ... | ... | ... |

---

## [项目名] 项目详情 ⚠️ 需关注

**当前版本**: xxx（落后 N commits）

### API 层级问题
- 项目使用 [低层API]，应迁移到 [高层API]

### 危险调用模式
- **[文件名:行号]** - [描述调用模式和潜在问题]

### 需要迁移 (N)

1. **[文件名:行号]**
   - 问题: [具体问题描述]
   - 迁移: [迁移方案]
   - ⚠️ **行为变更**: [如有行为变更需特别说明]

### 测试重点
- [ ] [基于影响范围列出的测试项]

### 合并建议
❌ **不建议直接合并**，需先完成迁移

---

## 行动计划

### 立即可合并
- ✅ [项目] - 已是最新

### 需先处理
- ⚠️ [项目] - 完成 N 处迁移后可合并
```

## 约束条件

- **必须检查所有三个项目**，不能只检查当前项目
- **必须对比核心类的新旧实现**，不能只看 API 签名
- **必须检查调用模式**，评估是否受内部逻辑变更影响
- 对于版本落后的项目，必须检查其使用的 API 层级是否需要迁移

### ⛔ 禁止的错误判断

以下判断方式是**错误的**，会导致漏检：

1. ❌ "签名未变 = 向后兼容" → 必须检查内部实现
2. ❌ "编译通过 = 没问题" → 行为变更不会导致编译错误
3. ❌ "只有 1 处调用 = 影响小" → 要看这 1 处是否是关键路径
4. ❌ "DI 自动处理 = 不用管" → 要看注入的实现类行为是否变了
5. ❌ "项目没用高层 API = 该模块无影响" → 要查项目用了什么替代方案
6. ❌ "可能兼容，需测试验证" → 必须深入分析调用场景，给出明确结论

## 项目路径

基础路径: `~/AndroidStudioProjects/Work_Projects/`

| 项目 | 实际根目录 |
|------|-----------|
| POS | `android-pos/packages/pos/android/` |
| KDS | `android-kds/` |
| TV | `smart-screen/` |

## 历史教训

这个命令的核心价值是防止历史问题重演。

**最容易遗漏的问题**：方法签名没变，但内部行为变了。

**为什么容易遗漏**：
1. 方法签名没变，编译不报错
2. 没有 `@Deprecated` 标注
3. 简单场景正常，特定调用模式才出问题

**检查要点**：
1. 不仅看 API 签名，还要看**内部实现差异**
2. 不仅看简单场景，还要看**各种调用模式**
3. 不仅看当前项目，还要看**所有使用该库的项目**
