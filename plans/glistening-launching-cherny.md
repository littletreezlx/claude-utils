# RAG 系统迁移方案 - 文档更新计划

## 任务目标

将本次技术评审讨论的关键决策整理回 `docs/features/RAG_SYSTEM_MIGRATION.md`，形成可执行的架构决策记录。

---

## 需要更新的内容

### 1. 数据库选型：双轨验证策略

**位置**：第 4.2 节 "本地数据库"

**更新内容**：
- 放弃 Isar（停止维护风险）
- 主选：ObjectBox 4.0+（原生 HNSW 向量索引）
- 备选：Drift + sqlite_vec（SQLite 生态稳定）
- Phase 0 双轨验证逻辑

---

### 2. 存储计算修正

**位置**：第 6.1 节 "规模量级影响"

**更新内容**：
- 修正向量存储估算：30MB → 120MB
- 计算公式：5000 文档 × 6 chunks × 1024 维 × 4 字节

---

### 3. 分块策略：Markdown AST 规则矩阵

**位置**：第 4.1 节 "文档分块策略"

**新增内容**：
| 场景 | AST 处理策略 |
|------|-------------|
| 嵌套列表 > 500 tokens | 降级切分 + 父级上下文元数据 |
| 表格 > 500 tokens | 整表保留或转 CSV，禁止按行切断 |
| 无标题文档 | 滑动窗口 + 30% 重叠 |
| Frontmatter (YAML) | 提取为元数据，不进入 Embedding |

---

### 4. 查询重写：三级分层阈值

**位置**：第 5.2 节 或新增 "查询预处理策略"

**更新内容**：
| 级别 | 字数范围 | 处理方式 |
|------|---------|---------|
| Level 1 | 0-20 字 | 不重写，直接 Embedding |
| Level 2 | 20-100 字 | 轻量处理（NLP 提取关键词）|
| Level 3 | > 100 字 | LLM 完整重写 |

---

### 5. BFF 缓存策略详解

**位置**：第 2.1 节 "BFF 层架构" 或新增子节

**新增内容**：
- Key 生成：`Hash("v1" + UserID + QueryText + HistorySummaryHash)`
- 存储：LRU Cache（lru-cache npm）
- 容量：max 5000 条
- TTL：7 天

---

### 6. 离线降级：客户端 Embedding 缓存

**位置**：第 2.1 节 "降级方案" 扩展

**新增内容**：
```dart
@Entity()
class QueryEmbeddingCache {
  @Id() int id;
  @Index() String queryHash;
  List<double> vector;
  DateTime lastUsed; // LRU 淘汰
}
```

逻辑：
1. 本地缓存 Hit → 全离线向量搜索
2. 本地缓存 Miss + 在线 → 请求 BFF 并写入缓存
3. 本地缓存 Miss + 离线 → 降级 TF-IDF

---

### 7. Phase 0 验证清单更新

**位置**：第 9.1 节 "Phase 0：验证"

**更新内容**：

| 优先级 | 验证任务 | 验证标准 | 风险应对 |
|--------|---------|---------|---------|
| P0 | 向量数据库选型 | sqlite_vec 和 ObjectBox 双轨 POC，对比 10k 向量写入和 Top-10 搜索耗时 | ObjectBox 失败则定案 sqlite_vec |
| P1 | Markdown AST 分块 | 复杂表格/嵌套列表测试，人工检查切分质量 | 调整遍历深度 |
| P2 | BFF 连通性 | 端到端延迟 < 800ms | 检查 NAS 网络配置 |
| P3 | 重写阈值测试 | 20 个不同长度 Query 测试 | 调整字数阈值 |

---

### 8. 决策记录更新

**位置**：第 11.1 节 "关键决策"

**更新/新增行**：

| 决策点 | 原决策 | 新决策 | 变更原因 |
|--------|-------|-------|---------|
| 本地数据库 | Isar | ObjectBox / sqlite_vec 双轨 | Isar 停止维护 |
| 存储估算 | 30MB | 120MB | 分块后向量数量 6x |
| 分块策略 | 固定字符 | Markdown AST | 保护表格/代码块 |
| 重写阈值 | 200 字 | 三级分层 (20/100) | 避免过度/不足重写 |
| 离线缓存 | 无 | QueryEmbeddingCache | 咖啡厅场景 |

---

## 涉及文件

| 文件 | 操作 |
|------|------|
| `docs/features/RAG_SYSTEM_MIGRATION.md` | 更新 |

---

## 执行步骤

1. 读取现有文档结构
2. 按上述 8 个模块逐一更新
3. 保持文档整体结构一致性
4. 更新版本历史（v1.2）
